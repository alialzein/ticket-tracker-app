<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Ticket Tracker</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéüÔ∏è</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1f2937;
        }

        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        .modal {
            transition: opacity 0.3s ease-in-out;
        }

        .loading-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .notification {
            transition: all 0.5s ease-in-out;
            transform: translateX(110%);
        }

        .notification.show {
            transform: translateX(0);
        }

        #tickets-footer.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        #sidebar,
        #on-leave-sidebar {
            transition: transform 0.3s ease-in-out;
        }

        #tickets-filter-bar div::-webkit-scrollbar {
            display: none;
        }

        #tickets-filter-bar div {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .glowing-pulse {
            animation: pulse 1.5s infinite;
        }

        .kudos-given {
            color: #4ade80 !important;
            /* A bright green color */
            transform: scale(1.1);
        }

        @keyframes pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(99, 102, 241, 0);
            }
        }

        .tab-button[data-active="true"] {
            background-color: #4f46e5;
            color: white;
        }

        .ticket-card {
            width: 100%;
            max-width: 1400px;
            /* or whatever fits your middle panel */
            margin: 0 auto;
            /* center it */
            overflow: hidden;
        }

        .note-container {
            width: 80%;
            max-width: 80%;
        }

        .note-text {
            word-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
            max-width: 100%;
        }

        .char-counter {
            transition: color 0.2s ease;
        }

        .char-counter.warning {
            color: #f59e0b;
        }

        .char-counter.danger {
            color: #ef4444;
        }

        .hover-scale {
            transition: transform 0.2s ease;
        }

        .hover-scale:hover {
            transform: scale(1.02);
        }

        .glassmorphism {
            backdrop-filter: blur(10px);
            background: rgba(31, 41, 55, 0.8);
            border: 1px solid rgba(75, 85, 99, 0.2);
        }

        .ticket-card.reminded-yellow {
            background-color: rgba(234, 179, 8, 0.2);
            border-left-color: #f59e0b !important;
        }

        .unread-activity p {
            color: #a5b4fc !important;
        }

        #tickets-footer {
            --footer-height: 120px;
            /* match your footer height */
        }

        .visitor-mode .ticket-card .flex.justify-end.items-center.gap-2 {
            display: none !important;
        }

        .visitor-mode .cursor-pointer {
            pointer-events: none;
        }

        .mentioned-note {
            border-left: 4px solid #818cf8 !important;
            /* A brighter indigo border */
            background-color: rgba(79, 70, 229, 0.15) !important;
            /* A very subtle background tint */
        }

        .mentioned-note .note-text {
            color: #e0e7ff !important;
            /* Lighter/brighter text color for the note content */
            font-weight: 500;
        }

        .mention-dropdown {
            display: none;
            /* Hidden by default */
            position: absolute;
            background: #1f2937;
            /* dark gray */
            border: 1px solid #4b5563;
            border-radius: 8px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 50;
        }

        .mention-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.875rem;
            /* text-sm */
            color: #d1d5db;
            /* gray-300 */
        }

        .mention-item:hover {
            background-color: #374151;
            /* gray-700 */
            color: white;
        }

        .glowing-pulse-red {
            animation: pulse-red 1.5s infinite;
        }

        @keyframes pulse-red {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                box-shadow: 0 0 0 8px rgba(239, 68, 68, 0);
            }
        }

        .lunch-timer {
            font-size: 0.7rem;
            /* A bit smaller */
            font-weight: 600;
            color: #fcd34d;
            /* amber-300 */
        }

        .lunch-warning {
            font-size: 1rem;
            color: #f87171;
            /* red-400 */
            animation: pulse-red 1s infinite;
        }

        .note-text-collapsible.collapsed {
            max-height: 3.5rem;
            /* Sets the maximum height to about 3 lines */
            overflow: hidden;
            position: relative;
            /* This creates a gentle fade-out effect at the bottom */
            -webkit-mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
            mask-image: linear-gradient(to bottom, black 50%, transparent 100%);
        }

        .toggle-note-btn {
            color: #93c5fd;
            /* light blue */
            font-weight: 600;
            cursor: pointer;
            font-size: 0.75rem;
            /* text-xs */
            margin-top: 4px;
        }

        .toggle-note-btn:hover {
            text-decoration: underline;
        }

        .kudos-btn.disabled {
            pointer-events: none;
            opacity: 0.6;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 text-white flex flex-col h-screen antialiased">

    <div id="loading-overlay"
        class="fixed inset-0 bg-gray-900 bg-opacity-95 backdrop-blur-md flex items-center justify-center z-50 hidden">
        <div class="text-center">
            <div
                class="loading-spinner w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full mx-auto mb-4">
            </div>
            <p class="text-white text-lg">Loading your workspace...</p>
        </div>
    </div>

    <div id="login-overlay"
        class="fixed inset-0 bg-gray-900 bg-opacity-90 backdrop-blur-md flex items-center justify-center z-50">
        <div class="glassmorphism p-8 rounded-xl shadow-2xl w-full max-w-sm fade-in">
            <div class="flex flex-col items-center justify-center mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-indigo-400 mb-2" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 00-2-2H5z" />
                </svg>
                <h2 class="text-3xl font-bold text-center text-white">Ticket Tracker</h2>
            </div>
            <div id="auth-form">
                <input id="email-input" type="email" placeholder="Email"
                    class="w-full bg-gray-700/50 backdrop-blur text-white p-3 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all border border-gray-600">
                <input id="password-input" type="password" placeholder="Password"
                    class="w-full bg-gray-700/50 backdrop-blur text-white p-3 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-all border border-gray-600">
                <button id="signin-btn"
                    class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 mb-2 hover-scale">Sign
                    In</button>
                <button id="signup-btn"
                    class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition-colors duration-300 hover-scale">Sign
                    Up</button>
                <p id="auth-error" class="text-red-400 text-sm mt-4 text-center"></p>
            </div>
        </div>
    </div>

    <div id="notification-panel" class="fixed top-5 right-5 z-50 space-y-3 w-80"></div>

    <div id="edit-modal"
        class="modal fixed inset-0 bg-gray-900 bg-opacity-90 backdrop-blur-md flex items-center justify-center z-40 hidden opacity-0">
        <div class="glassmorphism p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h2 class="text-2xl font-bold text-white mb-6">Edit Ticket</h2>
            <input type="hidden" id="edit-ticket-id">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="edit-subject" class="block text-sm font-medium text-gray-400 mb-1">Subject</label>
                    <input id="edit-subject" type="text"
                        class="w-full bg-gray-700/50 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 border border-gray-600">
                </div>
                <div>
                    <label for="edit-status" class="block text-sm font-medium text-gray-400 mb-1">Status</label>
                    <select id="edit-status"
                        class="w-full bg-gray-700/50 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 border border-gray-600">
                        <option>In Progress</option>
                        <option>Done</option>
                    </select>
                </div>
                <div>
                    <label for="edit-priority" class="block text-sm font-medium text-gray-400 mb-1">Priority</label>
                    <select id="edit-priority"
                        class="w-full bg-gray-700/50 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 border border-gray-600">
                        <option value="Low" selected>Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                        <option value="Urgent">Urgent</option>
                    </select>
                </div>


                <div>
                    <label for="edit-tags" class="block text-sm font-medium text-gray-400 mb-1">Tags
                        (comma-separated)</label>
                    <input id="edit-tags" type="text"
                        class="w-full bg-gray-700/50 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 border border-gray-600">
                </div>

                <div id="complexity-container" class="hidden">
                    <label for="edit-complexity" class="block text-sm font-medium text-gray-400 mb-1">Complexity
                        (1-5)</label>
                    <select id="edit-complexity"
                        class="w-full bg-gray-700/50 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 border border-gray-600">
                        <option value="1">1 (Simple)</option>
                        <option value="2">2 (Standard)</option>
                        <option value="3">3 (Involved)</option>
                        <option value="4">4 (Complex)</option>
                        <option value="5">5 (Very Complex)</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button onclick="closeEditModal()"
                    class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition-colors hover-scale">Cancel</button>
                <button onclick="updateTicket()"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition-colors hover-scale">Save
                    Changes</button>
            </div>
        </div>
    </div>


    <div id="confirm-modal"
        class="modal fixed inset-0 bg-gray-900 bg-opacity-90 backdrop-blur-md flex items-center justify-center z-50 hidden opacity-0">
        <div class="glassmorphism p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h2 id="confirm-title" class="text-2xl font-bold text-white mb-4">Confirm Action</h2>
            <p id="confirm-message" class="text-gray-300 mb-6">Are you sure you want to proceed?</p>
            <div class="flex justify-end gap-4">
                <button onclick="closeConfirmModal()"
                    class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition-colors hover-scale">Cancel</button>
                <button id="confirm-btn"
                    class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors hover-scale">Confirm</button>
            </div>
        </div>
    </div>

    <div id="new-password-modal"
        class="modal fixed inset-0 bg-gray-900 bg-opacity-90 backdrop-blur-md flex items-center justify-center z-50 hidden opacity-0">
        <div class="glassmorphism p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-white mb-6 text-center">Set a New Password</h2>

            <input id="new-password-input" type="password" placeholder="Enter your new password"
                class="w-full bg-gray-700/50 text-white p-3 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500 border border-gray-600">

            <button onclick="setNewPassword()"
                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg transition-colors hover-scale">
                Save New Password
            </button>
        </div>
    </div>

    <div id="schedule-modal"
        class="modal fixed inset-0 bg-gray-900 bg-opacity-90 backdrop-blur-md flex items-center justify-center z-40 hidden opacity-0">
        <div class="glassmorphism p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">Team Schedule</h2>
                <button onclick="closeScheduleModal()"
                    class="text-gray-400 hover:text-white text-2xl transition-colors">&times;</button>
            </div>
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                <input type="date" id="schedule-date-picker" onchange="fetchSchedule()"
                    class="bg-gray-700/50 backdrop-blur p-2 rounded-lg border border-gray-600">
                <div id="admin-schedule-buttons" class="hidden flex gap-2">
                    <button onclick="openDefaultScheduleModal()"
                        class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg hover-scale">Manage
                        Defaults</button>
                    <button onclick="toggleScheduleEdit(true)"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg hover-scale">Edit
                        Date</button>
                </div>
            </div>
            <div id="overridden-dates-info"
                class="text-xs text-center text-indigo-300 mb-4 p-2 glassmorphism rounded-md hidden"></div>
            <div id="schedule-display" class="overflow-y-auto space-y-2"></div>
            <div id="schedule-edit-form" class="hidden overflow-y-auto space-y-3"></div>
            <div id="schedule-edit-actions" class="hidden justify-end gap-4 mt-6">
                <button onclick="toggleScheduleEdit(false)"
                    class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg hover-scale">Cancel</button>
                <button onclick="saveSchedule()"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg hover-scale">Save
                    Date Override</button>
            </div>
        </div>
    </div>

    <div id="default-schedule-modal"
        class="modal fixed inset-0 bg-gray-900 bg-opacity-90 backdrop-blur-md flex items-center justify-center z-50 hidden opacity-0">
        <div class="glassmorphism p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">Manage Default Weekly Schedule</h2>
                <button onclick="closeDefaultScheduleModal()"
                    class="text-gray-400 hover:text-white text-2xl transition-colors">&times;</button>
            </div>
            <div class="flex border-b border-gray-700 mb-4">
                <button class="tab-button py-2 px-4 font-semibold" data-day="1"
                    onclick="switchDayTab(this, 1)">Mon</button>
                <button class="tab-button py-2 px-4 font-semibold text-gray-400" data-day="2"
                    onclick="switchDayTab(this, 2)">Tue</button>
                <button class="tab-button py-2 px-4 font-semibold text-gray-400" data-day="3"
                    onclick="switchDayTab(this, 3)">Wed</button>
                <button class="tab-button py-2 px-4 font-semibold text-gray-400" data-day="4"
                    onclick="switchDayTab(this, 4)">Thu</button>
                <button class="tab-button py-2 px-4 font-semibold text-gray-400" data-day="5"
                    onclick="switchDayTab(this, 5)">Fri</button>
                <button class="tab-button py-2 px-4 font-semibold text-gray-400" data-day="6"
                    onclick="switchDayTab(this, 6)">Sat</button>
                <button class="tab-button py-2 px-4 font-semibold text-gray-400" data-day="7"
                    onclick="switchDayTab(this, 7)">Sun</button>
            </div>
            <div id="default-schedule-form" class="overflow-y-auto space-y-3"></div>
            <div class="flex justify-end gap-4 mt-6">
                <button onclick="closeDefaultScheduleModal()"
                    class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg hover-scale">Cancel</button>
                <button onclick="saveDefaultSchedule()"
                    class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg hover-scale">Save
                    Defaults</button>
            </div>
        </div>
    </div>

    <div id="admin-panel-modal"
        class="modal fixed inset-0 bg-gray-900 bg-opacity-90 backdrop-blur-md flex items-center justify-center z-40 hidden opacity-0">
        <div class="glassmorphism p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">Admin Panel</h2>
                <button onclick="closeAdminModal()"
                    class="text-gray-400 hover:text-white text-3xl transition-colors">&times;</button>
            </div>

            <div class="overflow-y-auto pr-2 space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="border border-gray-700 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold text-yellow-300 mb-2">Find and Delete a Ticket</h4>
                        <p class="text-sm text-gray-400 mb-4">Search for a ticket by its subject to delete it.</p>
                        <div class="flex items-center gap-2">
                            <input type="text" id="admin-search-subject-input" placeholder="Enter ticket subject..."
                                class="w-full bg-gray-700/50 text-white p-2 rounded-lg border border-gray-600">
                            <button onclick="searchTickets_Admin()"
                                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">Search</button>
                        </div>
                        <div id="admin-ticket-search-results" class="mt-4 space-y-2"></div>
                    </div>

                    <div class="border border-gray-700 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold text-yellow-300 mb-2">Reset User Password</h4>
                        <p class="text-sm text-gray-400 mb-4">Select a user to send them a password reset email.</p>
                        <div class="flex items-center gap-2">
                            <select id="admin-reset-user-select"
                                class="w-full bg-gray-700/50 text-white p-2 rounded-lg border border-gray-600">
                                <option>Select User</option>
                            </select>
                            <button onclick="sendPasswordReset_Admin()"
                                class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">Send
                                Reset</button>
                        </div>
                    </div>
                </div>

                <div class="border border-gray-700 p-4 rounded-lg">
                    <h4 class="text-lg font-semibold text-yellow-300 mb-2">Ping a User</h4>
                    <p class="text-sm text-gray-400 mb-4">Send an immediate, real-time pop-up message to a specific
                        user.</p>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 items-center">
                        <select id="admin-ping-user-select"
                            class="sm:col-span-1 bg-gray-700/50 text-white p-2 rounded-lg border border-gray-600">
                            <option>Select User</option>
                        </select>
                        <input type="text" id="admin-ping-message" placeholder="Enter short message..."
                            class="sm:col-span-2 bg-gray-700/50 text-white p-2 rounded-lg border border-gray-600">
                    </div>
                    <button onclick="pingUser_Admin()"
                        class="mt-4 w-full bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">Ping
                        User</button>
                </div>

                <div class="border border-gray-700 p-4 rounded-lg">
                    <h4 class="text-lg font-semibold text-yellow-300 mb-2">Attendance Report</h4>
                    <p class="text-sm text-gray-400 mb-4">Generate a shift report for a user over a specific period.</p>

                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 items-end">
                        <div class="md:col-span-2">
                            <label for="admin-report-user-select"
                                class="block text-xs font-medium text-gray-400 mb-1">Team Member</label>
                            <select id="admin-report-user-select"
                                class="w-full bg-gray-700/50 text-white p-2 rounded-lg border border-gray-600">
                                <option value="">Select a User</option>
                            </select>
                        </div>

                        <div>
                            <label for="admin-report-start-date"
                                class="block text-xs font-medium text-gray-400 mb-1">Start Date</label>
                            <input type="date" id="admin-report-start-date"
                                class="w-full bg-gray-700/50 text-white p-2 rounded-lg border border-gray-600">
                        </div>

                        <div>
                            <label for="admin-report-end-date" class="block text-xs font-medium text-gray-400 mb-1">End
                                Date</label>
                            <input type="date" id="admin-report-end-date"
                                class="w-full bg-gray-700/50 text-white p-2 rounded-lg border border-gray-600">
                        </div>
                    </div>

                    <button onclick="generateAttendanceReport()"
                        class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">
                        Generate Report
                    </button>

                    <div id="admin-attendance-report-results" class="mt-4 max-h-64 overflow-y-auto"></div>
                </div>


                <div class="border border-gray-700 p-4 rounded-lg">
                    <h4 class="text-lg font-semibold text-yellow-300 mb-2">User Activity Log</h4>
                    <p class="text-sm text-gray-400 mb-4">Generate or export a detailed point history for a user.</p>

                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 items-end">
                        <div class="md:col-span-2">
                            <label for="admin-log-user-select" class="block text-xs font-medium text-gray-400 mb-1">Team
                                Member</label>
                            <select id="admin-log-user-select"
                                class="w-full bg-gray-700/50 text-white p-2 rounded-lg border border-gray-600">
                            </select>
                        </div>

                        <div>
                            <label for="admin-log-start-date" class="block text-xs font-medium text-gray-400 mb-1">Start
                                Date</label>
                            <input type="date" id="admin-log-start-date"
                                class="w-full bg-gray-700/50 text-white p-2 rounded-lg border border-gray-600">
                        </div>

                        <div>
                            <label for="admin-log-end-date" class="block text-xs font-medium text-gray-400 mb-1">End
                                Date</label>
                            <input type="date" id="admin-log-end-date"
                                class="w-full bg-gray-700/50 text-white p-2 rounded-lg border border-gray-600">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <button onclick="generateUserActivityReport()"
                            class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">
                            Generate Log
                        </button>
                        <button onclick="exportUserActivityReport()"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">
                            Export to Excel
                        </button>
                    </div>

                    <div id="admin-user-log-results" class="mt-4 max-h-64 overflow-y-auto"></div>
                </div>

                <div class="border border-gray-700 p-4 rounded-lg">
                    <h4 class="text-lg font-semibold text-yellow-300 mb-2">Weekly Score History</h4>
                    <p class="text-sm text-gray-400 mb-4">Review or export a user's total weekly scores.</p>

                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 items-end">
                        <div class="md:col-span-2">
                            <label for="admin-history-user-select"
                                class="block text-xs font-medium text-gray-400 mb-1">Team Member</label>
                            <select id="admin-history-user-select"
                                class="w-full bg-gray-700/50 text-white p-2 rounded-lg border border-gray-600">
                            </select>
                        </div>

                        <div>
                            <label for="admin-history-start-date"
                                class="block text-xs font-medium text-gray-400 mb-1">Start Date</label>
                            <input type="date" id="admin-history-start-date"
                                class="w-full bg-gray-700/50 text-white p-2 rounded-lg border border-gray-600">
                        </div>

                        <div>
                            <label for="admin-history-end-date" class="block text-xs font-medium text-gray-400 mb-1">End
                                Date</label>
                            <input type="date" id="admin-history-end-date"
                                class="w-full bg-gray-700/50 text-white p-2 rounded-lg border border-gray-600">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <button onclick="generateWeeklyHistoryReport()"
                            class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">
                            Generate Report
                        </button>
                        <button onclick="exportWeeklyHistoryReport()"
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">
                            Export to Excel
                        </button>
                    </div>

                    <div id="admin-weekly-history-results" class="mt-4 max-h-64 overflow-y-auto"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="border border-gray-700 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold text-yellow-300 mb-2">Export Tickets by Date</h4>
                        <p class="text-sm text-gray-400 mb-4">Export tickets from the database created in a specific
                            date range.</p>
                        <div class="flex items-center gap-4 mb-4">
                            <div>
                                <label for="export-start-date"
                                    class="block text-xs font-medium text-gray-400 mb-1">Start Date</label>
                                <input type="date" id="export-start-date"
                                    class="bg-gray-700/50 text-white p-2 rounded-lg border border-gray-600 w-full">
                            </div>
                            <div>
                                <label for="export-end-date" class="block text-xs font-medium text-gray-400 mb-1">End
                                    Date</label>
                                <input type="date" id="export-end-date"
                                    class="bg-gray-700/50 text-white p-2 rounded-lg border border-gray-600 w-full">
                            </div>
                        </div>
                        <button onclick="exportTicketsByDate()"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">Export
                            by Date</button>
                    </div>
                    <div class="border border-gray-700 p-4 rounded-lg">
                        <h4 class="text-lg font-semibold text-yellow-300 mb-2">Broadcast Message</h4>
                        <p class="text-sm text-gray-400 mb-4">Post a global message for all users.</p>
                        <textarea id="broadcast-input" rows="2"
                            class="w-full bg-gray-700/50 text-white p-2 rounded-lg border border-gray-600"></textarea>
                        <button onclick="postBroadcastMessage()"
                            class="mt-2 w-full bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">Post
                            Message</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="completed-items-modal"
        class="modal fixed inset-0 bg-gray-900 bg-opacity-90 backdrop-blur-md flex items-center justify-center z-50 hidden opacity-0">
        <div class="glassmorphism p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">Completed History</h2>
                <button onclick="closeCompletedItemsModal()"
                    class="text-gray-400 hover:text-white text-3xl transition-colors">&times;</button>
            </div>
            <div id="history-list" class="overflow-y-auto space-y-3 pr-2">

                <div class="border border-gray-700 p-4 rounded-lg">
                    <h4 class="text-lg font-semibold text-yellow-300 mb-2">Attendance Report</h4>

                </div>


            </div>
        </div>
    </div>

    <div id="edit-schedule-item-modal"
        class="modal fixed inset-0 bg-gray-900 bg-opacity-90 backdrop-blur-md flex items-center justify-center z-50 hidden opacity-0">
        <div class="glassmorphism p-8 rounded-xl shadow-2xl w-full max-w-lg">
            <h2 class="text-2xl font-bold text-white mb-6">Edit Item</h2>
            <input type="hidden" id="edit-item-id">

            <div class="space-y-4">
                <div>
                    <label for="edit-item-text" class="block text-sm font-medium text-gray-400 mb-1">Details</label>
                    <textarea id="edit-item-text" rows="3"
                        class="w-full bg-gray-700/50 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 border border-gray-600"></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="edit-item-type" class="block text-sm font-medium text-gray-400 mb-1">Type</label>
                        <select id="edit-item-type"
                            class="w-full bg-gray-700/50 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 border border-gray-600">
                            <option>Deployment</option>
                            <option>Meeting</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-item-date" class="block text-sm font-medium text-gray-400 mb-1">Date</label>
                        <input id="edit-item-date" type="date"
                            class="w-full bg-gray-700/50 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 border border-gray-600">
                    </div>
                    <div>
                        <label for="edit-item-time" class="block text-sm font-medium text-gray-400 mb-1">Time</label>
                        <input id="edit-item-time" type="time"
                            class="w-full bg-gray-700/50 text-white p-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 border border-gray-600">
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-4 mt-6">
                <button onclick="closeEditScheduleItemModal()"
                    class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition-colors hover-scale">Cancel</button>
                <button onclick="updateScheduleItem()"
                    class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition-colors hover-scale">Save
                    Changes</button>
            </div>
        </div>
    </div>


    <div id="performance-modal"
        class="modal fixed inset-0 bg-gray-900 bg-opacity-90 backdrop-blur-md flex items-center justify-center z-50 hidden opacity-0">
        <div class="glassmorphism p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h2 id="performance-header" class="text-2xl font-bold text-white">My Performance</h2>
                <button id="close-performance-modal-btn"
                    class="text-gray-400 hover:text-white text-3xl transition-colors">&times;</button>
            </div>

            <div id="performance-content" class="overflow-y-auto pr-2 space-y-6">
            </div>
        </div>
    </div>

    <div id="history-modal"
        class="modal fixed inset-0 bg-gray-900 bg-opacity-90 backdrop-blur-md flex items-center justify-center z-50 hidden opacity-0">
        <div class="glassmorphism p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">Hall of Fame üëë</h2>
                <button onclick="closeHistoryModal()"
                    class="text-gray-400 hover:text-white text-3xl transition-colors">&times;</button>
            </div>
            <div id="leaderboard-history-content" class="overflow-y-auto space-y-3 pr-2">
            </div>
        </div>
    </div>



    <div id="app-container" class="hidden flex flex-col h-screen">
        <div id="broadcast-message-container"
            class="hidden w-full bg-yellow-500 text-black p-3 text-center shadow-lg fixed top-0 left-0 right-0 z-[100]">
            <p class="font-semibold"><span id="broadcast-message-text"></span></p>
            <button onclick="dismissBroadcast()"
                class="absolute top-1/2 right-4 -translate-y-1/2 font-bold text-2xl hover:text-gray-700 transition-colors">&times;</button>
        </div>

        <header class="glassmorphism border-b border-gray-700/50 p-3 shadow-lg w-full">
            <div class="flex justify-between items-center max-w-7xl mx-auto">
                <div class="flex-1">
                    <div class="flex items-center gap-3">
                        <button onclick="toggleSidebar()"
                            class="md:hidden p-2 rounded-md hover:bg-gray-700/50 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                        </button>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-400 hidden sm:block"
                            fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 00-2-2H5z" />
                        </svg>
                    </div>
                </div>
                <div class="text-center">
                    <h2
                        class="text-2xl font-bold text-white bg-gradient-to-r from-indigo-400 to-purple-400 bg-clip-text text-transparent">
                        B-PAL Support</h2>
                </div>
                <div class="flex-1 flex justify-end items-center gap-4">
                    <button id="open-admin-panel-btn" onclick="openAdminModal()"
                        class="hidden p-2 rounded-full hover:bg-gray-700/50 transition-colors" title="Admin Panel">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                    </button>
                    <button onclick="toggleRightSidebar()"
                        class="lg:hidden p-2 rounded-md hover:bg-gray-700/50 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <div id="sidebar-backdrop" onclick="toggleSidebar()"
            class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden"></div>
        <div id="right-sidebar-backdrop" onclick="toggleRightSidebar()"
            class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden lg:hidden"></div>

        <div class="flex flex-grow overflow-hidden relative">

            <aside id="sidebar"
                class="w-64 glassmorphism p-4 border-r border-gray-700/50 flex-col overflow-y-auto fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 md:flex z-30">
                <div class="flex justify-between items-center mb-4">
                    <h1 class="text-base sm:text-xl font-bold text-white">Welcome, <span id="current-user"
                            class="text-indigo-400"></span>!</h1>
                    <div class="flex justify-center">
                        <button id="my-performance-btn" class="text-xs mt-3 font-semibold text-gray-300 bg-gray-700/80 
                   py-1.5 px-4 rounded-full transition-colors 
                   hover:bg-teal-600 hover:text-white hover-scale">
                            My Performance
                        </button>
                    </div>


                    <button onclick="toggleSidebar()"
                        class="md:hidden p-1 rounded-md hover:bg-gray-700/50 transition-colors">&times;</button>
                </div>
                <div class="flex justify-between items-center mb-4 gap-2">
                    <h3 class="text-lg font-semibold">Team Stats</h3>
                    <div class="flex items-center gap-1">
                        <select id="stats-period" onchange="toggleCustomDaysInput()"
                            class="bg-gray-700/50 text-white text-sm p-1 rounded-md border border-gray-600">
                            <option value="2" selected>Last 2 Days</option>
                            <option value="7">Last 7 Days</option>
                            <option value="30">Last 30 Days</option>
                            <option value="custom">Custom</option>
                        </select>
                        <input type="number" id="custom-days-input" onchange="applyFilters()"
                            class="hidden bg-gray-700/50 w-16 text-white text-sm p-1 rounded-md border border-gray-600"
                            placeholder="Days">
                    </div>
                </div>
                <div id="stats-container" class="space-y-3"></div>
                <hr class="my-4 border-gray-700">
                <button id="open-history-btn"
                    class="w-full text-base font-semibold mb-2 text-center text-white hover:text-amber-300 transition-colors duration-300 group">
                    Weekly Leaderboard
                    <span class="text-amber-400 group-hover:scale-125 transition-transform inline-block">üèÜ</span>
                </button>
                <div id="leaderboard-container" class="space-y-2">
                </div>
            </aside>

            <div class="flex-grow flex flex-col overflow-hidden min-w-0">
                <div class="glassmorphism border-b border-gray-700/50 p-1">
                    <div class="relative flex items-center bg-gray-900/50 rounded-lg">
                        <div id="tab-indicator"
                            class="absolute top-0 bottom-0 h-full rounded-md bg-indigo-600 transition-all duration-300 ease-in-out">
                        </div>
                        <button onclick="switchView('dashboard', this)" id="tab-dashboard"
                            class="tab-btn flex-1 py-2 px-4 text-center font-semibold text-gray-400 hover:text-white transition-colors relative z-10 text-sm sm:text-base">Dashboard</button>
                        <button onclick="switchView('tickets', this)" id="tab-tickets"
                            class="tab-btn flex-1 py-2 px-4 text-center font-semibold text-white transition-colors relative z-10 text-sm sm:text-base">In
                            Progress</button>
                        <button onclick="switchView('done', this)" id="tab-done"
                            class="tab-btn flex-1 py-2 px-4 text-center font-semibold text-gray-400 hover:text-white transition-colors relative z-10 text-sm sm:text-base">Done</button>
                        <button onclick="switchView('follow-up', this)" id="tab-follow-up"
                            class="tab-btn flex-1 py-2 px-4 text-center font-semibold text-gray-400 hover:text-white transition-colors relative z-10 text-sm sm:text-base">
                            Follow-up
                            <span id="follow-up-dot"
                                class="absolute top-1 right-2 h-3 w-3 bg-red-500 rounded-full hidden border-2 border-gray-800"></span>
                        </button>
                    </div>
                </div>

                <div id="tickets-filter-bar" class="glassmorphism p-2 border-b border-gray-700/50">
                    <div class="max-w-7xl mx-auto flex flex-wrap items-center gap-2">
                        <input id="search-input" type="text" placeholder="Search... (Ctrl+F)"
                            class="w-48 sm:w-auto bg-gray-700/50 text-white p-2 rounded-lg border border-gray-600">
                        <select id="filter-user" onchange="applyFilters()"
                            class="w-40 sm:w-auto bg-gray-700/50 text-white p-2 rounded-lg border border-gray-600">
                            <option value="">All Users</option>
                        </select>
                        <select id="filter-source" onchange="applyFilters()"
                            class="w-40 sm:w-auto bg-gray-700/50 text-white p-2 rounded-lg border border-gray-600">
                            <option value="">All Sources</option>
                            <option>Outlook</option>
                            <option>Teams</option>
                        </select>
                        <select id="filter-priority" onchange="applyFilters()"
                            class="w-40 sm:w-auto bg-gray-700/50 text-white p-2 rounded-lg border border-gray-600">
                            <option value="">All Priorities</option>
                            <option>Low</option>
                            <option>Medium</option>
                            <option>High</option>
                            <option>Urgent</option>
                        </select>
                        <button onclick="exportTicketsToCSV()" id="export-btn"
                            class="hidden bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-3 rounded-lg text-sm ml-auto">Export
                            View</button>
                    </div>
                </div>

                <main class="flex-grow p-2 sm:p-4 overflow-y-auto mb-24 ">
                    <div id="dashboard-view" class="h-full">
                        <div
                            class="flex flex-col md:flex-row justify-between items-center mb-6 glassmorphism p-4 rounded-lg gap-4">
                            <h2 class="text-xl md:text-2xl font-bold text-white">Analytics Dashboard</h2>
                            <div class="flex items-center gap-2 w-full md:w-auto">
                                <label for="dashboard-user-filter" class="text-sm font-medium text-gray-400">Stats
                                    For:</label>
                                <select id="dashboard-user-filter" onchange="renderDashboard()"
                                    class="bg-gray-700/50 text-white p-2 rounded-lg w-full border border-gray-600">
                                    <option value="all">All Team Members</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                            <div id="avg-resolution-time-container" class="glassmorphism p-4 rounded-lg text-center">
                            </div>
                            <div id="tickets-by-source-container" class="glassmorphism p-4 rounded-lg"></div>
                            <div id="tickets-by-priority-container" class="glassmorphism p-4 rounded-lg"></div>
                        </div>
                        <div class="glassmorphism p-4 rounded-lg">
                            <div id="tickets-per-day-container" style="height: 300px;"></div>
                        </div>
                    </div>
                    <div id="tickets-view" class="hidden">
                        <div id="ticket-list" class="pr-2 space-y-4"></div>
                        <div id="load-more-container" class="text-center py-4">
                            <button id="load-more-btn" onclick="fetchTickets(false)"
                                class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg hidden hover-scale">Load
                                More</button>
                        </div>
                    </div>
                    <div id="done-view" class="hidden">
                        <div id="done-ticket-list" class="pr-2 space-y-4"></div>
                        <div id="load-more-done-container" class="text-center py-4">
                            <button id="load-more-btn-done" onclick="fetchTickets(false)"
                                class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-5 rounded-lg hidden hover-scale">Load
                                More</button>
                        </div>
                    </div>
                    <div id="follow-up-view" class="hidden">
                        <div id="follow-up-ticket-list" class="pr-2 space-y-4"></div>
                    </div>
                </main>
            </div>

            <aside id="on-leave-sidebar"
                class="w-64 glassmorphism p-4 border-l border-gray-700/50 flex flex-col overflow-y-auto fixed inset-y-0 right-0 transform translate-x-full lg:relative lg:translate-x-0 z-30">

                <div class="flex justify-end lg:hidden mb-2">
                    <button onclick="toggleRightSidebar()"
                        class="p-1 rounded-md hover:bg-gray-700/50 transition-colors">&times;</button>
                </div>
                <div class="space-y-2 mb-6">
                    <div class="relative">
                        <button id="activity-btn" onclick="toggleActivityLog()"
                            class="w-full flex items-center justify-center gap-2 p-2 rounded-lg hover:bg-gray-700/50 transition-colors hover-scale">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                            </svg>
                            Activity
                            <span id="activity-dot"
                                class="absolute top-1 right-1 h-3 w-3 bg-red-500 rounded-full hidden border-2 border-gray-800"></span>
                        </button>
                    </div>
                    <button id="shift-btn" onclick="toggleShift()"
                        class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors hover-scale">Start
                        Shift</button>
                    <div id="shift-reminder-container" class="text-center text-xs text-yellow-300 h-4"></div>
                    <div class="relative">
                        <button id="schedule-btn" onclick="openScheduleModal()"
                            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg relative hover-scale">
                            View Schedule
                            <span id="schedule-dot"
                                class="absolute top-1 right-1 h-3 w-3 bg-red-500 rounded-full hidden border-2 border-gray-800"></span>
                        </button>
                    </div>
                </div>
                <h3 class="text-lg font-semibold mb-4 text-center">Upcoming Absences</h3>
                <div id="on-leave-notes" class="space-y-3"></div>
                <hr class="my-6 border-gray-700">
                <div>
                    <div>
                        <h3 class="text-lg font-semibold text-center mb-3">Deployments & Meetings</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="openCompletedItemsModal()"
                                class="w-full bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 rounded-lg text-sm transition-colors hover-scale">
                                History üìú
                            </button>
                            <button onclick="toggleItemForm()" id="add-deployment-btn"
                                class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 rounded-lg text-sm transition-colors hover-scale">
                                Add ‚ûï
                            </button>
                        </div>
                    </div>

                    <div id="deployment-form"
                        class="hidden mb-4 glassmorphism p-3 rounded-lg border border-gray-600/30">
                        <textarea id="deployment-note-text"
                            class="w-full bg-gray-700/50 text-white p-2 rounded-lg border border-gray-600 text-sm mb-2"
                            placeholder="Enter details..." maxlength="500" rows="3"></textarea>

                        <select id="item-type-select"
                            class="w-full bg-gray-700/50 text-white p-2 rounded-lg border border-gray-600 text-sm mb-2">
                            <option>Deployment</option>
                            <option>Meeting</option>
                        </select>

                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <input type="date" id="deployment-date"
                                class="bg-gray-700/50 text-white p-2 rounded-lg border border-gray-600 text-sm">
                            <input type="time" id="deployment-time"
                                class="bg-gray-700/50 text-white p-2 rounded-lg border border-gray-600 text-sm">
                        </div>

                        <div class="flex justify-end gap-2">
                            <button onclick="toggleItemForm()"
                                class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-1 px-3 rounded-lg text-sm">
                                Cancel
                            </button>
                            <button onclick="saveScheduleItem()"
                                class="bg-green-600 hover:bg-green-700 text-white font-semibold py-1 px-3 rounded-lg text-sm">
                                Save
                            </button>
                        </div>
                    </div>
                </div>

                <div id="deployment-notes-list" class="space-y-3 mt-4"></div>
        </div>


        </aside>
    </div>
    <footer id="tickets-footer"
        class="glassmorphism p-2 sm:p-4 border-t border-gray-700/50 fixed bottom-0 left-64 right-64 z-20">
        <div class="max-w-7xl mx-auto">
            <div class="bg-gray-900/50 rounded-xl p-2 grid grid-cols-2 gap-2 sm:flex sm:items-center sm:flex-wrap">
                <div class="col-span-2 flex space-x-2">
                    <button onclick="selectSource('Outlook')"
                        class="source-btn flex-1 bg-gray-700/50 hover:bg-blue-600 data-[selected=true]:bg-blue-500 text-gray-300 font-semibold py-2 px-3 text-sm sm:px-4 sm:text-base rounded-lg transition-colors hover-scale border border-gray-600">Outlook</button>
                    <button onclick="selectSource('Teams')"
                        class="source-btn flex-1 bg-gray-700/50 hover:bg-purple-600 data-[selected=true]:bg-purple-500 text-gray-300 font-semibold py-2 px-3 text-sm sm:px-4 sm:text-base rounded-lg transition-colors hover-scale border border-gray-600">Teams</button>
                </div>
                <input id="ticket-subject" type="text"
                    class="col-span-2 sm:flex-grow sm:min-w-[200px] bg-gray-700/50 p-3 rounded-lg border border-gray-600 focus:ring-2 focus:ring-indigo-500"
                    placeholder="Enter ticket subject...">
                <select id="assign-to" class="hidden sm:block bg-gray-700/50 p-3 rounded-lg border border-gray-600">
                    <option value="">Assign to</option>
                </select>
                <select id="ticket-priority"
                    class="hidden sm:block bg-gray-700/50 p-3 rounded-lg border border-gray-600">
                    <option selected>Low</option>
                    <option>Medium</option>
                    <option>High</option>
                    <option>Urgent</option>
                </select>
                <input id="ticket-tags" type="text"
                    class="hidden sm:block bg-gray-700/50 p-3 rounded-lg border border-gray-600"
                    placeholder="Tags (e.g. login)">
                <button onclick="createTicket()"
                    class="col-span-2 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 text-sm sm:text-base sm:px-5 rounded-lg hover-scale">Create</button>
            </div>
        </div>
    </footer>


    <button onclick="signOut()"
        class="fixed bottom-4 right-4 bg-red-500 hover:bg-red-600 text-white font-bold p-3 rounded-full shadow-lg z-50 hover-scale">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"
            stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
        </svg>
    </button>
    </div>

    <div id="activity-log"
        class="fixed top-20 right-5 w-72 glassmorphism rounded-lg shadow-lg hidden overflow-hidden z-50 max-h-80">
        <div class="p-4 border-b border-gray-700 font-bold">Recent Activity</div>
        <div id="activity-list" class="max-h-96 overflow-y-auto"></div>
    </div>

    <script defer>
        // --- SUPABASE SETUP ---
        const SUPABASE_URL = 'https://gdapxyyrvcwknjmcplna.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdkYXB4eXlydmN3a25qbWNwbG5hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MTA0MzAsImV4cCI6MjA3MzA4NjQzMH0.Jla3hIjQuGLBBrsK-vyguEjC7RA0y4o10d8FULSeznc';
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { auth: { persistSession: true, storage: localStorage } });

        // --- APP STATE ---
        let currentUser = null, tickets = [], doneTickets = [], followUpTickets = [];
        let allUsers = new Map(), userEmailMap = new Map(), attendance = new Map();
        let currentShiftId = null, selectedSource = null, currentAlarm = null;
        let currentPage = 0, doneCurrentPage = 0;
        const TICKETS_PER_PAGE = 20;
        let confirmCallback = null, currentView = 'tickets';
        let charts = {};
        const MAX_NOTE_LENGTH = 3000;
        let shiftReminderInterval = null, autoEndShiftInterval = null;
        let deploymentNotes = [];
        let currentUserRole = null;
        let lunchTimerInterval = null;

        // This code should run when your application loads
        _supabase.auth.onAuthStateChange(async (event, session) => {
            // This event is triggered when the user clicks the password recovery link
            if (event === 'PASSWORD_RECOVERY') {
                // Here, you should display a modal or a form
                // where the user can enter their new password.
                // For example:
                openNewPasswordModal(); // A custom function you will create
            }
        });

        // --- UTILITY FUNCTIONS ---
        const USER_COLORS = [
            { bg: 'bg-slate-500/30', text: 'text-slate-300' }, { bg: 'bg-gray-500/30', text: 'text-gray-300' }, { bg: 'bg-zinc-500/30', text: 'text-zinc-300' },
            { bg: 'bg-neutral-500/30', text: 'text-neutral-300' }, { bg: 'bg-stone-500/30', text: 'text-stone-300' }, { bg: 'bg-red-500/30', text: 'text-red-300' },
            { bg: 'bg-orange-500/30', text: 'text-orange-300' }, { bg: 'bg-amber-500/30', text: 'text-amber-300' }, { bg: 'bg-yellow-500/30', text: 'text-yellow-300' },
            { bg: 'bg-lime-500/30', text: 'text-lime-300' }, { bg: 'bg-green-500/30', text: 'text-green-300' }, { bg: 'bg-emerald-500/30', text: 'text-emerald-300' },
            { bg: 'bg-teal-500/30', text: 'text-teal-300' }, { bg: 'bg-cyan-500/30', text: 'text-cyan-300' }, { bg: 'bg-sky-500/30', text: 'text-sky-300' },
            { bg: 'bg-blue-500/30', text: 'text-blue-300' }, { bg: 'bg-indigo-500/30', text: 'text-indigo-300' }, { bg: 'bg-violet-500/30', text: 'text-violet-300' },
            { bg: 'bg-purple-500/30', text: 'text-purple-300' }, { bg: 'bg-fuchsia-500/30', text: 'text-fuchsia-300' }, { bg: 'bg-pink-500/30', text: 'text-pink-300' },
            { bg: 'bg-rose-500/30', text: 'text-rose-300' }
        ];
        const debounce = (func, delay) => {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        };
        const debouncedApplyFilters = debounce(applyFilters, 500);
        function getUserColor(username) {
            let hash = 0;
            if (!username) return USER_COLORS[0];
            for (let i = 0; i < username.length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
            }
            return USER_COLORS[Math.abs(hash % USER_COLORS.length)];
        }
        const PRIORITY_STYLES = { 'Urgent': { bg: 'bg-red-500', text: 'text-white' }, 'High': { bg: 'bg-orange-500', text: 'text-white' }, 'Medium': { bg: 'bg-yellow-500', text: 'text-gray-900' }, 'Low': { bg: 'bg-green-500', text: 'text-white' } };
        function showLoading() { document.getElementById('loading-overlay').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loading-overlay').classList.add('hidden'); }
        function showNotification(title, body, type = 'info', createSystemNotification = true) {
            const panel = document.getElementById('notification-panel');
            const id = `notif-${Date.now()}`;
            const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-indigo-500' };
            const notification = document.createElement('div');
            notification.id = id;
            notification.className = `notification w-full p-4 rounded-lg shadow-lg text-white ${colors[type]} glassmorphism`;
            notification.innerHTML = `<p class="font-bold">${title}</p><p class="text-sm">${body}</p>`;
            panel.appendChild(notification);
            setTimeout(() => { notification.classList.add('show'); }, 10);
            setTimeout(() => { notification.classList.remove('show'); setTimeout(() => notification.remove(), 500); }, 5000);
            if (Notification.permission === 'granted' && createSystemNotification) { new Notification(title, { body }); }
        }
        function formatTime(timeString) {
            if (!timeString) return '';
            const [hour, minute] = timeString.split(':');
            let h = parseInt(hour, 10);
            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12;
            h = h ? h : 12;
            return `${h}:${minute.padStart(2, '0')} ${ampm}`;
        }

        async function checkAndDisableUIForVisitor() {
            try {
                const { data, error } = await _supabase
                    .from('user_roles')
                    .select('role')
                    .eq('user_id', currentUser.id)
                    .single();

                if (error && error.code !== 'PGRST116') throw error; // Ignore "not found" errors

                if (data) {
                    // This is the fix: Set the role for ANY user who has one.
                    currentUserRole = data.role;

                    // If the user is a visitor, hide the main action buttons.
                    if (data.role === 'visitor_admin') {
                        document.getElementById('tickets-footer').style.display = 'none';
                        document.getElementById('shift-btn').style.display = 'none';
                        document.getElementById('add-deployment-btn').parentElement.style.display = 'none';
                        document.body.classList.add('visitor-mode');
                    }
                }
            } catch (err) {
                console.error("Error checking user role:", err);
            }
        }

        function updateCharCounter(inputId, counterId, maxLength) {
            const input = document.getElementById(inputId);
            const counter = document.getElementById(counterId);
            if (!input || !counter) return;
            const currentLength = input.value.length;
            const remaining = maxLength - currentLength;
            counter.textContent = `${remaining} characters remaining`;
            counter.classList.remove('warning', 'danger');
            if (remaining <= 50 && remaining > 20) {
                counter.classList.add('warning');
            } else if (remaining <= 20) {
                counter.classList.add('danger');
            }
        }

        // Renamed from toggleDeploymentForm
        function toggleItemForm() {
            const form = document.getElementById('deployment-form');
            const btn = document.getElementById('add-deployment-btn');

            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                btn.textContent = 'Cancel ‚ùå';
                // Change button color to red
                btn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                btn.classList.add('bg-red-600', 'hover:bg-red-700');
                document.getElementById('deployment-date').value = new Date().toISOString().split('T')[0];
            } else {
                form.classList.add('hidden');
                btn.textContent = 'Add ‚ûï';
                // Change button color back to indigo
                btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                btn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                document.getElementById('deployment-note-text').value = '';
                document.getElementById('deployment-date').value = '';
                document.getElementById('deployment-time').value = '';
            }
        }
        // Renamed and updated from saveDeploymentNote
        async function saveScheduleItem() {
            const noteText = document.getElementById('deployment-note-text').value.trim();
            const itemDate = document.getElementById('deployment-date').value;
            const itemTime = document.getElementById('deployment-time').value;
            const itemType = document.getElementById('item-type-select').value;

            if (!noteText || !itemDate) {
                return showNotification('Missing Information', 'Please enter details and a date.', 'error');
            }

            try {
                const { error } = await _supabase.from('deployment_notes').insert({
                    user_id: currentUser.id,
                    username: currentUser.user_metadata.display_name || currentUser.email.split('@')[0],
                    note_text: noteText,
                    deployment_date: itemDate,
                    deployment_time: itemTime || null,
                    type: itemType
                });

                if (error) throw error;
                awardPoints('SCHEDULE_ITEM_ADDED', { itemType: itemType });

                showNotification('Success', `${itemType} added successfully.`, 'success');
                toggleItemForm();

                // ADD THIS LINE TO REFRESH THE LIST INSTANTLY
                await fetchScheduleItems();

            } catch (err) {
                console.error('Error saving item:', err);
                showNotification('Error', 'Failed to save item.', 'error');
            }
        }

        // Renamed from fetchDeploymentNotes
        async function fetchScheduleItems() {
            try {
                const { data, error } = await _supabase.from('deployment_notes')
                    .select('*').eq('is_completed', false)
                    .order('deployment_date', { ascending: true })
                    .order('deployment_time', { ascending: true });
                if (error) throw error;
                deploymentNotes = data || [];
                renderScheduleItems();
            } catch (err) {
                console.error('Error fetching schedule items:', err);
            }
        }

        // Renamed and updated from renderDeploymentNotes
        function renderScheduleItems() {
            const container = document.getElementById('deployment-notes-list');
            if (!deploymentNotes || deploymentNotes.length === 0) {
                container.innerHTML = '<p class="text-sm text-center text-gray-400">No upcoming deployments or meetings.</p>';
                return;
            }
            const today = new Date(); today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today); tomorrow.setDate(tomorrow.getDate() + 1);
            container.innerHTML = '';

            deploymentNotes.forEach(note => {
                const itemDate = new Date(note.deployment_date + 'T00:00:00');
                const isToday = itemDate.getTime() === today.getTime();
                const isTomorrow = itemDate.getTime() === tomorrow.getTime();
                const isPast = itemDate < today;
                let dateString; let alertClass = ''; let alertIcon = '';
                if (isPast) { dateString = 'OVERDUE'; alertClass = 'bg-red-500/30 border-l-4 border-red-500'; alertIcon = '‚ö†Ô∏è'; }
                else if (isToday) { dateString = 'TODAY'; alertClass = 'bg-yellow-500/30 border-l-4 border-yellow-500'; alertIcon = 'üö®'; }
                else if (isTomorrow) { dateString = 'Tomorrow'; alertClass = 'bg-blue-500/20 border-l-4 border-blue-500'; alertIcon = 'üìÖ'; }
                else { dateString = itemDate.toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric' }); alertClass = 'glassmorphism border border-gray-600/30'; }

                const typeIcon = note.type === 'Meeting' ? 'ü§ù' : 'üöÄ';
                const timeString = note.deployment_time ? ` at ${formatTime(note.deployment_time)}` : '';
                const userColor = getUserColor(note.username);
                const isMyNote = note.user_id === currentUser.id;

                container.innerHTML += `
        <div id="item-${note.id}" class="p-3 rounded-lg transition-all ${alertClass}">
            <div class="flex items-start justify-between mb-2">
                <div class="flex items-center gap-2">
                    <span class="text-lg">${alertIcon || typeIcon}</span>
                    <p class="font-bold ${userColor.text} text-sm">${note.username}</p>
                </div>
                <div class="flex items-center gap-1">
                    <button onclick="markItemComplete(${note.id})" class="text-gray-400 hover:text-green-400 p-1" title="Mark as completed"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/></svg></button>
					     ${isMyNote ? `<button onclick="openEditScheduleItemModal(${note.id})" class="text-gray-400 hover:text-indigo-400 p-1" title="Edit item"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg></button>` : ''}
                    ${isMyNote ? `<button onclick="deleteScheduleItem(${note.id})" class="text-gray-400 hover:text-red-400 p-1" title="Delete item"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg></button>` : ''}
                </div>
            </div>
            <p class="text-white text-sm leading-relaxed mb-2">${note.note_text}</p>
            <p class="text-xs font-semibold ${isToday || isPast ? 'text-white' : 'text-gray-300'}">${dateString}${timeString}</p>
        </div>`;
            });
        }

        async function awardPoints(eventType, data = {}, target = null) {
            try {
                // If a target is provided, use their ID and name. Otherwise, use the current user.
                const targetUserId = target ? target.userId : currentUser.id;
                const targetUsername = target ? target.username : (currentUser.user_metadata.display_name || currentUser.email.split('@')[0]);

                const { error } = await _supabase.functions.invoke('smart-task', {
                    body: {
                        eventType,
                        userId: targetUserId,
                        username: targetUsername,
                        data
                    },
                });
                if (error) throw error;
            } catch (err) {
                console.error(`Failed to award points for ${eventType}:`, err);
            }
        }



        // Renamed from markDeploymentComplete
        async function markItemComplete(noteId) {
            try {
                const { error } = await _supabase.from('deployment_notes')
                    .update({ is_completed: true }).eq('id', noteId);
                if (error) throw error;
                showNotification('Success', 'Item marked as completed.', 'success');
            } catch (err) {
                showNotification('Error', 'Failed to update item status.', 'error');
            }
        }

        // Renamed from deleteDeploymentNote
        async function deleteScheduleItem(noteId) {
            openConfirmModal('Delete Item', 'Are you sure you want to delete this item?', async () => {
                try {
                    const { error } = await _supabase.from('deployment_notes').delete().eq('id', noteId);
                    if (error) throw error;
                    showNotification('Success', 'Item deleted.', 'success');
                } catch (err) {
                    showNotification('Error', 'Failed to delete item.', 'error');
                }
            });
        }


        // Add these new functions near your other schedule item logic

        function openEditScheduleItemModal(itemId) {
            // Find the item data from the array we already fetched
            const itemToEdit = deploymentNotes.find(note => note.id === itemId);
            if (!itemToEdit) {
                console.error("Could not find item to edit");
                return;
            }

            // Populate the modal fields with the item's current data
            document.getElementById('edit-item-id').value = itemToEdit.id;
            document.getElementById('edit-item-text').value = itemToEdit.note_text;
            document.getElementById('edit-item-type').value = itemToEdit.type;
            document.getElementById('edit-item-date').value = itemToEdit.deployment_date;
            document.getElementById('edit-item-time').value = itemToEdit.deployment_time;

            // Show the modal
            const modal = document.getElementById('edit-schedule-item-modal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
        }

        function closeEditScheduleItemModal() {
            const modal = document.getElementById('edit-schedule-item-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        async function updateScheduleItem() {
            const itemId = document.getElementById('edit-item-id').value;
            const noteText = document.getElementById('edit-item-text').value.trim();
            const itemType = document.getElementById('edit-item-type').value;
            const itemDate = document.getElementById('edit-item-date').value;
            const itemTime = document.getElementById('edit-item-time').value;

            if (!noteText || !itemDate) {
                return showNotification('Missing Information', 'Please ensure details and a date are provided.', 'error');
            }

            const updatePayload = {
                note_text: noteText,
                type: itemType,
                deployment_date: itemDate,
                deployment_time: itemTime || null
            };

            try {
                const { error } = await _supabase.from('deployment_notes')
                    .update(updatePayload)
                    .eq('id', itemId);

                if (error) throw error;

                showNotification('Success', 'Item updated successfully.', 'success');
                closeEditScheduleItemModal();
                // The real-time subscription will automatically refresh the list
            } catch (err) {
                console.error('Error updating item:', err);
                showNotification('Error', 'Failed to update the item.', 'error');
            }
        }


        async function fetchCompletedItems() {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '<div class="text-center text-gray-400">Loading history...</div>';

            try {
                const { data, error } = await _supabase.from('deployment_notes')
                    .select('*')
                    .eq('is_completed', true)
                    .order('deployment_date', { ascending: false })
                    .limit(50); // Show the last 50 completed items

                if (error) throw error;

                if (data.length === 0) {
                    historyList.innerHTML = '<div class="text-center text-gray-400">No completed items found.</div>';
                    return;
                }

                historyList.innerHTML = data.map(item => {
                    const itemDate = new Date(item.deployment_date + 'T00:00:00').toLocaleDateString();
                    const typeIcon = item.type === 'Meeting' ? 'ü§ù' : 'üöÄ';
                    return `
                <div class="bg-gray-800/50 p-3 rounded-lg">
                    <div class="flex justify-between items-center">
                        <p class="font-semibold text-white">
                            <span class="mr-2">${typeIcon}</span>${item.note_text}
                        </p>
                        <span class="text-xs text-gray-300">${itemDate}</span>
                    </div>
                    <p class="text-xs text-gray-400 mt-1 pl-7">Added by ${item.username}</p>
                </div>
            `;
                }).join('');

            } catch (err) {
                historyList.innerHTML = '<div class="text-center text-red-400">Error loading history.</div>';
                console.error("Error fetching history:", err);
            }
        }



        // --- ADMIN PANEL FUNCTIONS ---
        function openAdminModal() {
            const modal = document.getElementById('admin-panel-modal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
        }
        function closeAdminModal() {
            const modal = document.getElementById('admin-panel-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
        async function deleteTicketById_Admin(ticketId) {
            // No need to get the ID from an input anymore.
            if (!ticketId) {
                return showNotification('Error', 'Invalid Ticket ID provided.', 'error');
            }

            openConfirmModal('Delete Ticket', `Are you sure you want to permanently delete ticket #${ticketId}?`, async () => {
                try {
                    const { error } = await _supabase.from('tickets').delete().eq('id', ticketId);
                    if (error) throw error;

                    logActivity('TICKET_DELETED', { ticket_id: ticketId });
                    showNotification('Success', `Ticket #${ticketId} has been deleted.`, 'success');

                    // Remove the deleted ticket from the search results instantly
                    const resultElement = document.getElementById(`search-result-${ticketId}`);
                    if (resultElement) {
                        resultElement.remove();
                    }

                } catch (error) {
                    showNotification('Error Deleting Ticket', error.message, 'error');
                }
            });
        }

        function openCompletedItemsModal() {
            const modal = document.getElementById('completed-items-modal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
            fetchCompletedItems(); // Call the renamed fetch function
        }

        function closeCompletedItemsModal() {
            const modal = document.getElementById('completed-items-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }


        function openHistoryModal() {
            const modal = document.getElementById('history-modal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
            renderLeaderboardHistory();
        }

        function closeHistoryModal() {
            const modal = document.getElementById('history-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        async function renderLeaderboardHistory() {
            const content = document.getElementById('leaderboard-history-content');
            content.innerHTML = '<p class="text-center text-gray-400">Loading weekly winners...</p>';
            try {
                const { data, error } = await _supabase.from('leaderboard_history').select('*').order('week_start_date', { ascending: false });
                if (error) throw error;

                if (data.length === 0) {
                    content.innerHTML = '<p class="text-center text-gray-400">No weekly records found yet.</p>';
                    return;
                }

                content.innerHTML = data.map(record => `
                    <div class="glassmorphism p-4 my-2 rounded-lg border border-gray-700/50">
                        <p class="font-bold text-lg text-amber-300">Week of ${new Date(record.week_start_date + 'T00:00:00').toLocaleDateString()}</p>
                        <p class="mt-1">üèÜ Winner: <span class="font-semibold text-white">${record.winner_username}</span> with ${record.winner_score} pts</p>
                    </div>
                `).join('');
            } catch (err) {
                console.error("Failed to render leaderboard history:", err);
                content.innerHTML = '<p class="text-center text-red-400">Could not load history.</p>';
            }
        }


        function openPerformanceModal() {
            const modal = document.getElementById('performance-modal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
            renderPerformanceAnalytics(); // Render the data when the modal opens
        }

        function closePerformanceModal() {
            const modal = document.getElementById('performance-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        // Helper function to format seconds into "Xh Ym"
        function formatSeconds(seconds) {
            if (seconds === 0) return '0m';
            const h = Math.floor(seconds / 3600);
            const m = Math.round((seconds % 3600) / 60);
            return `${h > 0 ? h + 'h ' : ''}${m}m`;
        }

        async function renderPerformanceAnalytics() {
            const content = document.getElementById('performance-content');
            const header = document.getElementById('performance-header');
            const myName = currentUser.user_metadata.display_name || currentUser.email.split('@')[0];

            header.textContent = `My Performance (${myName})`;
            content.innerHTML = '<div class="loading-spinner w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full mx-auto"></div>';

            try {
                // Use the new SQL function to get all stats at once
                const { data, error } = await _supabase.rpc('get_user_performance_stats', {
                    user_name_param: myName,
                    days_limit: 7 // For the last 7 days
                });

                if (error) throw error;

                const myAvgTime = formatSeconds(data.user_stats.avg_resolution_seconds);
                const teamAvgTime = formatSeconds(data.team_stats.avg_resolution_seconds);
                const tagAnalysisHTML = data.tag_analysis.length > 0
                    ? data.tag_analysis.map(tag => `<div class="bg-gray-600/50 text-gray-300 text-sm font-semibold px-3 py-1 rounded-full border border-gray-500 flex justify-between"><span>#${tag.tag}</span><span>${tag.count}</span></div>`).join('')
                    : '<p class="text-gray-400 text-center">No tags handled in this period.</p>';

                // Construct the final HTML for the modal content
                content.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                        <div class="glassmorphism p-4 rounded-lg">
                            <h4 class="text-lg font-semibold text-gray-300 mb-2">Weekly Score üèÜ</h4>
                            <p class="text-5xl font-bold text-white">${data.user_stats.total_points}</p>
                            <p class="text-sm text-gray-400 mt-1">pts</p>
                        </div>
                        <div class="glassmorphism p-4 rounded-lg">
                            <h4 class="text-lg font-semibold text-gray-300 mb-2">Tickets Closed</h4>
                            <p class="text-5xl font-bold text-white">${data.user_stats.tickets_closed}</p>
                            <p class="text-sm text-gray-400 mt-1">Last 7 Days</p>
                        </div>
                        <div class="glassmorphism p-4 rounded-lg">
                            <h4 class="text-lg font-semibold text-gray-300 mb-2">Avg. Resolution Time</h4>
                            <p class="text-5xl font-bold text-white">${myAvgTime}</p>
                            <p class="text-sm text-gray-400 mt-1">Team Average: ${teamAvgTime}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="glassmorphism p-4 rounded-lg">
                            <h4 class="text-lg font-semibold text-gray-300 mb-4 text-center">My Top Tags (7 Days)</h4>
                            <div class="space-y-2">${tagAnalysisHTML}</div>
                        </div>
                        <div id="priority-chart-container" class="glassmorphism p-4 rounded-lg h-64"></div>
                    </div>
                `;

                // Render the personal priority chart
                const priorityLabels = Object.keys(data.priority_analysis);
                if (priorityLabels.length > 0) {
                    const priorityColorMap = { 'Low': '#22c55e', 'Medium': '#f59e0b', 'High': '#ef4444', 'Urgent': '#b91c1c' };
                    const priorityBackgroundColors = priorityLabels.map(label => priorityColorMap[label] || '#6b7280');
                    renderChart('priority-chart-container', 'myPriorityChart', 'doughnut', {
                        labels: priorityLabels,
                        datasets: [{ data: Object.values(data.priority_analysis), backgroundColor: priorityBackgroundColors }]
                    }, `My Tickets by Priority`);
                } else {
                    document.getElementById('priority-chart-container').innerHTML = '<p class="text-gray-400 text-center mt-8">No ticket data for chart.</p>';
                }

            } catch (err) {
                console.error("Failed to render performance analytics:", err);
                content.innerHTML = '<p class="text-center text-red-400">Could not load performance data.</p>';
            }
        }

        // ADD THIS ENTIRE NEW FUNCTION
        async function searchTickets_Admin() {
            const searchTerm = document.getElementById('admin-search-subject-input').value.trim();
            const resultsContainer = document.getElementById('admin-ticket-search-results');

            if (searchTerm.length < 3) {
                showNotification('Search Too Short', 'Please enter at least 3 characters to search.', 'error');
                return;
            }

            resultsContainer.innerHTML = '<div class="text-center text-gray-400">Searching...</div>';

            try {
                const { data: tickets, error } = await _supabase
                    .from('tickets')
                    .select('id, subject, username')
                    .ilike('subject', `%${searchTerm}%`) // ilike is a case-insensitive search
                    .limit(10); // Limit to 10 results to avoid overwhelming the UI

                if (error) throw error;

                if (tickets.length === 0) {
                    resultsContainer.innerHTML = '<div class="text-center text-gray-400">No tickets found.</div>';
                    return;
                }

                resultsContainer.innerHTML = ''; // Clear the 'Searching...' message
                tickets.forEach(ticket => {
                    const resultEl = document.createElement('div');
                    resultEl.id = `search-result-${ticket.id}`;
                    resultEl.className = 'bg-gray-800 p-3 rounded-lg flex justify-between items-center';
                    resultEl.innerHTML = `
                <div>
                    <p class="font-semibold text-white">#${ticket.id} - ${ticket.subject}</p>
                    <p class="text-xs text-gray-400">Created by ${ticket.username}</p>
                </div>
                <button onclick="deleteTicketById_Admin(${ticket.id})" class="bg-red-700 hover:bg-red-800 text-white font-semibold py-1 px-3 rounded-lg text-xs">Delete</button>
            `;
                    resultsContainer.appendChild(resultEl);
                });

            } catch (err) {
                resultsContainer.innerHTML = '<div class="text-center text-red-400">Error during search.</div>';
                showNotification('Search Error', err.message, 'error');
            }
        }
        async function sendPasswordReset_Admin() {
            const userSelect = document.getElementById('admin-reset-user-select');
            const username = userSelect.value;
            if (!username) {
                return showNotification('Error', 'Please select a user.', 'error');
            }
            const email = userEmailMap.get(username);
            if (!email) {
                return showNotification('Error', `Could not find an email for user ${username}.`, 'error');
            }
            openConfirmModal('Reset Password', `Are you sure you want to send a password reset link to ${username} (${email})?`, async () => {
                const { error } = await _supabase.auth.resetPasswordForEmail(email, {
                    redirectTo: window.location.origin,
                });
                if (error) {
                    showNotification('Error', error.message, 'error');
                } else {
                    showNotification('Success', `Password reset email sent to ${username}.`, 'success');
                }
            });
        }
        async function pingUser_Admin() {
            const userSelect = document.getElementById('admin-ping-user-select');
            const messageInput = document.getElementById('admin-ping-message');
            const username = userSelect.value;
            const message = messageInput.value.trim();

            if (!username || !message) {
                return showNotification('Error', 'Please select a user and enter a message.', 'error');
            }
            const userId = allUsers.get(username);
            if (!userId) {
                return showNotification('Error', `Could not find ID for user ${username}.`, 'error');
            }

            try {
                const { error } = await _supabase.from('pings').insert({
                    target_user_id: userId,
                    message: message
                });
                if (error) throw error;
                showNotification('Success', `Ping sent to ${username}.`, 'success');
                messageInput.value = '';
            } catch (err) {
                showNotification('Error', 'Could not send ping. ' + err.message, 'error');
            }
        }

        function toggleNoteExpansion(ticketId, noteIndex) {
            const noteTextElement = document.getElementById(`note-text-${ticketId}-${noteIndex}`);
            const toggleBtn = document.getElementById(`toggle-btn-${ticketId}-${noteIndex}`);

            // Toggle the 'collapsed' class and update the button text
            if (noteTextElement.classList.toggle('collapsed')) {
                toggleBtn.textContent = 'Show More ‚ñæ';
            } else {
                toggleBtn.textContent = 'Show Less ‚ñ¥';
            }
        }

        // ADD THIS ENTIRE BLOCK OF NEW FUNCTIONS

        async function generateAttendanceReport() {
            const selectedUsername = document.getElementById('admin-report-user-select').value;
            const startDate = document.getElementById('admin-report-start-date').value;
            const endDate = document.getElementById('admin-report-end-date').value;
            const resultsContainer = document.getElementById('admin-attendance-report-results');

            // --- 1. Validate Inputs ---
            if (!selectedUsername || !startDate || !endDate) {
                return showNotification('Error', 'Please select a user and both start and end dates.', 'error');
            }
            if (new Date(startDate) > new Date(endDate)) {
                return showNotification('Error', 'Start date cannot be after the end date.', 'error');
            }

            resultsContainer.innerHTML = '<p class="text-center text-gray-400">Fetching report...</p>';

            // --- 2. Query Supabase ---
            try {
                // Set end date to the very end of the selected day to include all shifts
                const endOfDay = new Date(endDate);
                endOfDay.setHours(23, 59, 59, 999);

                const { data, error } = await _supabase
                    .from('attendance')
                    .select('shift_start, shift_end,device_type')
                    .eq('username', selectedUsername)
                    .gte('shift_start', new Date(startDate).toISOString())
                    .lte('shift_start', endOfDay.toISOString())
                    .order('shift_start', { ascending: true });

                if (error) throw error;

                // --- 3. Render the results ---
                renderAttendanceReport(data);

            } catch (err) {
                resultsContainer.innerHTML = `<p class="text-center text-red-400">Failed to fetch report: ${err.message}</p>`;
                showNotification('Report Error', err.message, 'error');
            }
        }

        // Replace the entire function with this updated version
        function renderAttendanceReport(records) {
            const resultsContainer = document.getElementById('admin-attendance-report-results');

            if (!records || records.length === 0) {
                resultsContainer.innerHTML = '<p class="text-center text-gray-400">No attendance records found for this period.</p>';
                return;
            }

            // Create a table to display the data
            let tableHTML = `
    <table class="w-full text-sm text-left">
        <thead class="text-xs text-gray-300 uppercase bg-gray-700/50">
            <tr>
                <th scope="col" class="px-4 py-2">Date</th>
                <th scope="col" class="px-4 py-2">Shift Start</th>
                <th scope="col" class="px-4 py-2">Shift End</th>
                <th scope="col" class="px-4 py-2">Duration</th>
                <th scope="col" class="px-4 py-2">Device</th> </tr>
        </thead>
        <tbody>
    `;

            records.forEach(record => {
                const startDate = new Date(record.shift_start);
                const endDate = record.shift_end ? new Date(record.shift_end) : null;

                let duration = 'In Progress';
                if (endDate) {
                    const diffMs = endDate - startDate;
                    const hours = Math.floor(diffMs / 3600000);
                    const minutes = Math.floor((diffMs % 3600000) / 60000);
                    duration = `${hours}h ${minutes}m`;
                }

                // Logic to format the device type with an icon
                let deviceDisplay = record.device_type || 'N/A';
                if (record.device_type === 'desktop') {
                    deviceDisplay = 'üíª Desktop';
                } else if (record.device_type === 'mobile') {
                    deviceDisplay = 'üì± Mobile';
                }

                tableHTML += `
        <tr class="border-b border-gray-700">
            <td class="px-4 py-2">${startDate.toLocaleDateString()}</td>
            <td class="px-4 py-2">${startDate.toLocaleTimeString()}</td>
            <td class="px-4 py-2">${endDate ? endDate.toLocaleTimeString() : '---'}</td>
            <td class="px-4 py-2">${duration}</td>
            <td class="px-4 py-2">${deviceDisplay}</td> </tr>
        `;
            });

            tableHTML += '</tbody></table>';
            resultsContainer.innerHTML = tableHTML;
        }


        async function exportTicketsByDate() {
            const startDate = document.getElementById('export-start-date').value;
            const endDate = document.getElementById('export-end-date').value;

            if (!startDate || !endDate) {
                return showNotification('Error', 'Please select both a start and end date.', 'error');
            }
            if (new Date(startDate) > new Date(endDate)) {
                return showNotification('Error', 'Start date cannot be after the end date.', 'error');
            }

            showLoading();
            showNotification('Export Started', 'Fetching ticket data for the selected range...', 'info');

            try {
                const endOfDay = new Date(endDate);
                endOfDay.setHours(23, 59, 59, 999);

                const { data: tickets, error } = await _supabase
                    .from('tickets')
                    .select('*')
                    .gte('created_at', new Date(startDate).toISOString())
                    .lte('created_at', endOfDay.toISOString())
                    .order('created_at', { ascending: true });

                if (error) throw error;
                if (!tickets || tickets.length === 0) {
                    hideLoading();
                    return showNotification('No Data', 'No tickets found in the selected date range.', 'info');
                }

                const headers = ['ID', 'CreatedAt', 'UpdatedAt', 'CompletedAt', 'Username', 'Source', 'Subject', 'Status', 'Priority', 'AssignedTo', 'HandledBy', 'Tags', 'Notes', 'NeedsFollowup'];
                const csvRows = [headers.join(',')];
                const formatField = (field) => {
                    if (field === null || field === undefined) return '';
                    let fieldStr = String(field);
                    if (fieldStr.search(/("|,|\n)/g) >= 0) {
                        fieldStr = `"${fieldStr.replace(/"/g, '""')}"`;
                    }
                    return fieldStr;
                };

                for (const ticket of tickets) {
                    const handledBy = Array.isArray(ticket.handled_by) ? ticket.handled_by.join('; ') : '';
                    const tags = Array.isArray(ticket.tags) ? ticket.tags.join('; ') : '';
                    const notes = Array.isArray(ticket.notes) ? ticket.notes.map(n => `${n.username} (${new Date(n.timestamp).toLocaleString()}): ${n.text}`).join(' | ') : '';
                    const row = [ticket.id, ticket.created_at, ticket.updated_at, ticket.completed_at, ticket.username, ticket.source, ticket.subject, ticket.status, ticket.priority, ticket.assigned_to_name, handledBy, tags, notes, ticket.needs_followup].map(formatField);
                    csvRows.push(row.join(','));
                }

                const csvString = csvRows.join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `tickets-export-${startDate}-to-${endDate}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showNotification('Export Complete', `${tickets.length} tickets have been exported.`, 'success');
            } catch (err) {
                console.error("Error exporting tickets by date:", err);
                showNotification('Export Failed', err.message, 'error');
            } finally {
                hideLoading();
            }
        }
        async function exportTicketsToCSV() {
            let ticketsToExport, viewName;
            switch (currentView) {
                case 'tickets': ticketsToExport = tickets; viewName = 'InProgress'; break;
                case 'done': ticketsToExport = doneTickets; viewName = 'Done'; break;
                case 'follow-up': ticketsToExport = followUpTickets; viewName = 'FollowUp'; break;
                default: return showNotification('Export Error', 'Export is only available from a ticket view.', 'error');
            }

            if (!ticketsToExport || ticketsToExport.length === 0) {
                return showNotification('No Data', 'There are no tickets in the current view to export.', 'info');
            }

            showNotification('Export Started', `Exporting ${ticketsToExport.length} filtered tickets...`, 'info');

            try {
                const headers = ['ID', 'CreatedAt', 'UpdatedAt', 'CompletedAt', 'Username', 'Source', 'Subject', 'Status', 'Priority', 'AssignedTo', 'HandledBy', 'Tags', 'Notes', 'NeedsFollowup'];
                const csvRows = [headers.join(',')];
                const formatField = (field) => {
                    if (field === null || field === undefined) return '';
                    let fieldStr = String(field);
                    if (fieldStr.search(/("|,|\n)/g) >= 0) {
                        fieldStr = `"${fieldStr.replace(/"/g, '""')}"`;
                    }
                    return fieldStr;
                };

                for (const ticket of ticketsToExport) {
                    const handledBy = Array.isArray(ticket.handled_by) ? ticket.handled_by.join('; ') : '';
                    const tags = Array.isArray(ticket.tags) ? ticket.tags.join('; ') : '';
                    const notes = Array.isArray(ticket.notes) ? ticket.notes.map(n => `${n.username} (${new Date(n.timestamp).toLocaleString()}): ${n.text}`).join(' | ') : '';
                    const row = [ticket.id, ticket.created_at, ticket.updated_at, ticket.completed_at, ticket.username, ticket.source, ticket.subject, ticket.status, ticket.priority, ticket.assigned_to_name, handledBy, tags, notes, ticket.needs_followup].map(formatField);
                    csvRows.push(row.join(','));
                }

                const csvString = csvRows.join('\n');
                const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                const date = new Date().toISOString().split('T')[0];
                link.setAttribute('href', url);
                link.setAttribute('download', `tickets-export-${viewName}-${date}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (err) {
                console.error("Error exporting tickets:", err);
                showNotification('Export Failed', err.message, 'error');
            }
        }
        async function postBroadcastMessage() {
            const input = document.getElementById('broadcast-input');
            const message = input.value.trim();
            if (!message) return;
            showLoading();
            try {
                await _supabase.from('broadcast_messages').update({ is_active: false }).eq('is_active', true);
                const { error } = await _supabase.from('broadcast_messages').insert({ message: message, created_by: currentUser.id, is_active: true });
                if (error) throw error;
                input.value = '';
                showNotification('Success', 'Broadcast message posted!', 'success');
            } catch (err) {
                showNotification('Error', err.message, 'error');
            } finally {
                hideLoading();
            }
        }
        async function fetchBroadcastMessage() {
            try {
                const { data, error } = await _supabase.from('broadcast_messages').select('*').eq('is_active', true).order('created_at', { ascending: false }).limit(1).single();
                if (error && error.code !== 'PGRST116') throw error;
                const container = document.getElementById('broadcast-message-container');
                if (data) {
                    const dismissedId = sessionStorage.getItem('dismissedBroadcastId');
                    if (dismissedId === data.id.toString()) {
                        container.classList.add('hidden');
                        return;
                    }
                    document.getElementById('broadcast-message-text').textContent = data.message;
                    container.dataset.id = data.id;
                    container.classList.remove('hidden');
                } else {
                    container.classList.add('hidden');
                }
            } catch (err) {
                console.error("Error fetching broadcast:", err);
            }
        }


        async function renderLeaderboard() {
            const container = document.getElementById('leaderboard-container');
            if (!container) return;

            container.innerHTML = '<p class="text-sm text-center text-gray-400">Loading scores...</p>';

            try {
                // Call the SQL function for the last 7 days
                const { data, error } = await _supabase.rpc('get_leaderboard', { days_limit: 7 });

                if (error) throw error;

                if (!data || data.length === 0) {
                    container.innerHTML = '<p class="text-sm text-center text-gray-400">No scores recorded yet.</p>';
                    return;
                }

                const medals = ['ü•á', 'ü•à', 'ü•â'];

                container.innerHTML = data.map((user, index) => {
                    const userColor = getUserColor(user.username);
                    const rank = index < 3 ? medals[index] : `#${index + 1}`;

                    return `
                        <div class="glassmorphism p-2 rounded-lg flex items-center justify-between text-xs hover-scale">
                            <div class="flex items-center gap-2">
                                <span class="font-bold w-6 text-center text-sm">${rank}</span>
                                <span class="${userColor.text} font-semibold">${user.username}</span>
                            </div>
                            <span class="font-bold text-gray-200 bg-black/30 border border-gray-600/50 px-2 py-0.5 rounded-md text-xs">${user.total_points} pts</span>
                        </div>
                    `;
                }).join('');

            } catch (err) {
                console.error("Failed to render leaderboard:", err);
                container.innerHTML = '<p class="text-sm text-center text-red-400">Could not load scores.</p>';
            }
        }


        function dismissBroadcast() {
            const container = document.getElementById('broadcast-message-container');
            const messageId = container.dataset.id;
            if (messageId) {
                sessionStorage.setItem('dismissedBroadcastId', messageId);
            }
            container.classList.add('hidden');
        }

        // --- AUTH FUNCTIONS ---
        async function signIn() {
            const errorP = document.getElementById("auth-error");
            errorP.textContent = "";
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            showLoading();
            try {
                const { error } = await _supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;
            } catch (error) {
                console.error('Sign In Error:', error);
                errorP.textContent = error.message;
            } finally {
                hideLoading();
            }
        }
        async function signUp() {
            const emailInput = document.getElementById('email-input');
            const passwordInput = document.getElementById('password-input');
            const errorP = document.getElementById('auth-error');
            const email = emailInput.value;
            const password = passwordInput.value;
            showLoading();
            try {
                const { error } = await _supabase.auth.signUp({ email, password, options: { data: { display_name: email.split('@')[0] } } });
                if (error) throw error;
                errorP.style.color = 'rgb(74 222 128)';
                errorP.textContent = 'Success! Please check your email for a confirmation link.';
            } catch (error) {
                errorP.textContent = error.message;
            } finally {
                hideLoading();
            }
        }
        async function signOut() {
            if (lunchTimerInterval) clearInterval(lunchTimerInterval);
            showLoading(); const { error } = await _supabase.auth.signOut(); if (error) console.error('Sign Out Error:', error); hideLoading();
        }

        // --- DATA FETCHING & RENDERING ---
        function toggleCustomDaysInput() {
            const statsPeriod = document.getElementById('stats-period');
            const customDaysInput = document.getElementById('custom-days-input');
            if (statsPeriod.value === 'custom') {
                customDaysInput.classList.remove('hidden');
                customDaysInput.focus();
            } else {
                customDaysInput.classList.add('hidden');
                applyFilters();
            }
        }
        async function applyFilters() {
            currentPage = 0;
            doneCurrentPage = 0;
            await fetchTickets(true);
            await renderStats();
            renderOnLeaveNotes();
        }
        async function fetchUsers() {
            try {
                // NOTE: Your 'get_all_team_members' RPC must return user_id, username, and email for all features to work.
                const { data, error } = await _supabase.rpc('get_team_members');
                if (error) throw error;

                allUsers.clear();
                userEmailMap.clear();
                data.forEach(user => {
                    if (user.username) {
                        allUsers.set(user.username, user.user_id);
                        userEmailMap.set(user.username, user.email);
                    }
                });

                // Populate admin dropdowns
                const resetSelect = document.getElementById('admin-reset-user-select');
                const pingSelect = document.getElementById('admin-ping-user-select');
                const reportSelect = document.getElementById('admin-report-user-select'); // ADD THIS LINE
                const logSelect = document.getElementById('admin-log-user-select'); // ADD THIS
                const historySelect = document.getElementById('admin-history-user-select'); // ADD THIS



                resetSelect.innerHTML = '<option value="">Select User</option>';
                pingSelect.innerHTML = '<option value="">Select User</option>';
                reportSelect.innerHTML = '<option value="">Select a User</option>'; // ADD THIS LINE
                logSelect.innerHTML = '<option value="">Select a User</option><option value="all">All Users</option>'; // MODIFIED
                historySelect.innerHTML = '<option value="">Select a User</option><option value="all">All Users</option>'; // MODIFIED



                Array.from(allUsers.keys()).sort().forEach(name => {
                    resetSelect.innerHTML += `<option value="${name}">${name}</option>`;
                    pingSelect.innerHTML += `<option value="${name}">${name}</option>`;
                    reportSelect.innerHTML += `<option value="${name}">${name}</option>`; // ADD THIS LINE
                    logSelect.innerHTML += `<option value="${name}">${name}</option>`; // ADD THIS
                    historySelect.innerHTML += `<option value="${name}">${name}</option>`; // ADD THIS



                });

            } catch (err) {
                console.error('Exception fetching users:', err);
            }
        }

        // NEW: Helper function to handle CSV conversion and download
        function exportToCSV(data, filename) {
            if (!data || data.length === 0) {
                return showNotification('No Data', 'There is no data to export for the selected criteria.', 'info');
            }

            const headers = Object.keys(data[0]);
            const csvRows = [headers.join(',')]; // Header row

            for (const row of data) {
                const values = headers.map(header => {
                    let field = row[header];
                    if (field === null || field === undefined) {
                        field = '';
                    } else if (typeof field === 'object') {
                        field = JSON.stringify(field); // Handle JSON objects
                    }

                    const fieldStr = String(field);
                    // Escape quotes and wrap in quotes if it contains commas, quotes, or newlines
                    if (fieldStr.search(/("|,|\n)/g) >= 0) {
                        return `"${fieldStr.replace(/"/g, '""')}"`;
                    }
                    return fieldStr;
                });
                csvRows.push(values.join(','));
            }

            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', `${filename}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('Export Complete', `${filename}.csv has been downloaded.`, 'success');
        }

        // NEW: Function to export the detailed user activity log
        async function exportUserActivityReport() {
            const selectedUsername = document.getElementById('admin-log-user-select').value;
            const startDate = document.getElementById('admin-log-start-date').value;
            const endDate = document.getElementById('admin-log-end-date').value;

            if (!selectedUsername || !startDate || !endDate) {
                return showNotification('Error', 'Please select a user (or "All Users") and both start and end dates.', 'error');
            }

            showLoading();
            try {
                const endOfDay = new Date(endDate);
                endOfDay.setHours(23, 59, 59, 999);

                let query = _supabase.from('user_points').select('created_at, username, event_type, points_awarded, details, related_ticket_id');

                if (selectedUsername !== 'all') {
                    query = query.eq('username', selectedUsername);
                }

                const { data, error } = await query
                    .gte('created_at', new Date(startDate).toISOString())
                    .lte('created_at', endOfDay.toISOString())
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const filename = `UserActivityLog-${selectedUsername}-${startDate}-to-${endDate}`;
                exportToCSV(data, filename);

            } catch (err) {
                showNotification('Export Failed', `Failed to fetch log data: ${err.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // NEW: Function to export the weekly history report
        async function exportWeeklyHistoryReport() {
            const selectedUsername = document.getElementById('admin-history-user-select').value;
            const startDate = document.getElementById('admin-history-start-date').value;
            const endDate = document.getElementById('admin-history-end-date').value;

            if (!selectedUsername || !startDate || !endDate) {
                return showNotification('Error', 'Please select a user (or "All Users") and both start and end dates.', 'error');
            }

            showLoading();
            try {
                let query = _supabase.from('weekly_leaderboard').select('week_start_date, username, total_score');

                if (selectedUsername !== 'all') {
                    query = query.eq('username', selectedUsername);
                }

                const { data, error } = await query
                    .gte('week_start_date', startDate)
                    .lte('week_start_date', endDate)
                    .order('week_start_date', { ascending: false });

                if (error) throw error;

                const filename = `WeeklyHistory-${selectedUsername}-${startDate}-to-${endDate}`;
                exportToCSV(data, filename);

            } catch (err) {
                showNotification('Export Failed', `Failed to fetch history data: ${err.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function generateWeeklyHistoryReport() {
            const selectedUsername = document.getElementById('admin-history-user-select').value;
            const startDate = document.getElementById('admin-history-start-date').value;
            const endDate = document.getElementById('admin-history-end-date').value;
            const resultsContainer = document.getElementById('admin-weekly-history-results');

            if (!selectedUsername || !startDate || !endDate) {
                return showNotification('Error', 'Please select a user and both start and end dates.', 'error');
            }

            resultsContainer.innerHTML = '<p class="text-center text-gray-400">Fetching weekly history...</p>';

            try {
                const { data, error } = await _supabase
                    .from('weekly_leaderboard')
                    .select('week_start_date, total_score')
                    .eq('username', selectedUsername)
                    .gte('week_start_date', startDate)
                    .lte('week_start_date', endDate)
                    .order('week_start_date', { ascending: false });

                if (error) throw error;

                if (!data || data.length === 0) {
                    resultsContainer.innerHTML = '<p class="text-center text-gray-400">No weekly score history found for this user in this period.</p>';
                    return;
                }

                resultsContainer.innerHTML = data.map(record => {
                    const weekStart = new Date(record.week_start_date + 'T00:00:00').toLocaleDateString();
                    const pointClass = record.total_score >= 0 ? 'text-green-400' : 'text-red-400';
                    const sign = record.total_score > 0 ? '+' : '';
                    return `
                <div class="bg-gray-800/50 p-3 rounded-lg text-sm mb-2">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-white">Week of ${weekStart}</span>
                        <span class="font-bold text-lg ${pointClass}">${sign}${record.total_score} pts</span>
                    </div>
                </div>
            `;
                }).join('');

            } catch (err) {
                resultsContainer.innerHTML = `<p class="text-center text-red-400">Failed to fetch history: ${err.message}</p>`;
            }
        }

        async function generateUserActivityReport() {
            const selectedUsername = document.getElementById('admin-log-user-select').value;
            const startDate = document.getElementById('admin-log-start-date').value;
            const endDate = document.getElementById('admin-log-end-date').value;
            const resultsContainer = document.getElementById('admin-user-log-results');

            if (!selectedUsername || !startDate || !endDate) {
                return showNotification('Error', 'Please select a user and both start and end dates.', 'error');
            }

            resultsContainer.innerHTML = '<p class="text-center text-gray-400">Fetching logs...</p>';

            try {
                const endOfDay = new Date(endDate);
                endOfDay.setHours(23, 59, 59, 999);

                const { data, error } = await _supabase
                    .from('user_points')
                    .select('*')
                    .eq('username', selectedUsername)
                    .gte('created_at', new Date(startDate).toISOString())
                    .lte('created_at', endOfDay.toISOString())
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!data || data.length === 0) {
                    resultsContainer.innerHTML = '<p class="text-center text-gray-400">No activity found for this user in this period.</p>';
                    return;
                }

                resultsContainer.innerHTML = data.map(log => {
                    const pointClass = log.points_awarded > 0 ? 'text-green-400' : 'text-red-400';
                    const sign = log.points_awarded > 0 ? '+' : '';
                    return `
                <div class="bg-gray-800/50 p-3 rounded-lg text-sm mb-2">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold ${pointClass}">${sign}${log.points_awarded} pts</span>
                        <span class="text-xs text-gray-500">${new Date(log.created_at).toLocaleString()}</span>
                    </div>
                    <p class="text-gray-300 mt-1">${log.details.reason || 'No reason provided'}</p>
                </div>
            `;
                }).join('');

            } catch (err) {
                resultsContainer.innerHTML = `<p class="text-center text-red-400">Failed to fetch logs: ${err.message}</p>`;
            }
        }


        async function fetchTickets(isNew = false) {
            if (isNew) {
                showLoading();
            } else {
                const btnId = currentView === 'done' ? 'load-more-btn-done' : 'load-more-btn';
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.innerHTML = '<div class="loading-spinner w-5 h-5 mx-auto"></div>';
                    btn.disabled = true;
                }
            }

            try {
                const isDoneView = currentView === 'done';
                const isFollowUpView = currentView === 'follow-up';
                let pageToFetch = isDoneView ? doneCurrentPage : currentPage;
                if (isNew) pageToFetch = 0;

                const searchTerm = document.getElementById('search-input').value.trim();
                const periodSelect = document.getElementById('stats-period');
                let daysToFilter = parseInt(periodSelect.value);
                if (periodSelect.value === 'custom') {
                    daysToFilter = parseInt(document.getElementById('custom-days-input').value) || 0;
                }
                const startDate = new Date();
                startDate.setHours(0, 0, 0, 0);
                startDate.setDate(startDate.getDate() - (daysToFilter - 1));

                let query;
                if (isFollowUpView) {
                    query = _supabase.from('tickets').select('*').eq('needs_followup', true);
                    // Also filter follow-up tickets by their last update
                    query = query.gte('updated_at', startDate.toISOString());
                } else {
                    const statusToFetch = isDoneView ? 'Done' : 'In Progress';
                    query = _supabase.from('tickets').select('*').eq('status', statusToFetch);

                    // --- THIS IS THE KEY CHANGE ---
                    // Filter by the 'updated_at' column instead of 'created_at'
                    query = query.gte('updated_at', startDate.toISOString());
                    // --- END OF CHANGE ---
                }

                if (searchTerm) query = query.ilike('subject', `%${searchTerm}%`);
                const userFilter = document.getElementById('filter-user').value;
                if (userFilter) query = query.or(`username.eq.${userFilter},assigned_to_name.eq.${userFilter}`);
                const sourceFilter = document.getElementById('filter-source').value;
                if (sourceFilter) query = query.eq('source', sourceFilter);
                const priorityFilter = document.getElementById('filter-priority').value;
                if (priorityFilter) query = query.eq('priority', priorityFilter);

                query = query.order('updated_at', { ascending: false });

                query = query.range(pageToFetch * TICKETS_PER_PAGE, (pageToFetch + 1) * TICKETS_PER_PAGE - 1);

                const { data, error } = await query;
                if (error) throw error;

                if (isFollowUpView) {
                    followUpTickets = data || [];
                } else if (data && data.length > 0) {
                    if (isDoneView) {
                        if (isNew) { doneTickets = data; } else { doneTickets.push(...data); }
                        doneCurrentPage++;
                        document.getElementById('load-more-btn-done').style.display = (data.length === TICKETS_PER_PAGE) ? 'inline-block' : 'none';
                    } else {
                        if (isNew) { tickets = data; } else { tickets.push(...data); }
                        currentPage++;
                        document.getElementById('load-more-btn').style.display = (data.length === TICKETS_PER_PAGE) ? 'inline-block' : 'none';
                    }
                } else {
                    if (isNew) {
                        if (isDoneView) { doneTickets = []; } else { tickets = []; }
                    }
                    if (isDoneView) { document.getElementById('load-more-btn-done').style.display = 'none'; }
                    else { document.getElementById('load-more-btn').style.display = 'none'; }
                }

                renderTickets();
            } catch (err) {
                console.error('Exception fetching tickets:', err);
            } finally {
                if (isNew) {
                    hideLoading();
                } else {
                    const btnId = currentView === 'done' ? 'load-more-btn-done' : 'load-more-btn';
                    const btn = document.getElementById(btnId);
                    if (btn) {
                        btn.innerHTML = 'Load More';
                        btn.disabled = false;
                    }
                }
                checkReminders(currentView === 'done' ? doneTickets : tickets);
            }
        }


        function getDeviceType() {
            // A screen width less than 768px is a common breakpoint for mobile devices.
            if (window.innerWidth < 768) {
                return 'mobile';
            } else {
                return 'desktop';
            }
        }


        async function renderTickets() {
            let ticketData, ticketList;
            const myName = currentUser.user_metadata.display_name || currentUser.email.split('@')[0];
            const isDoneView = currentView === 'done';
            const isFollowUpView = currentView === 'follow-up';

            if (isFollowUpView) {
                ticketData = followUpTickets;
                ticketList = document.getElementById('follow-up-ticket-list');
            } else if (isDoneView) {
                ticketData = doneTickets;
                ticketList = document.getElementById('done-ticket-list');
            } else {
                ticketData = tickets;
                ticketList = document.getElementById('ticket-list');
            }

            if (!ticketData) return;

            if ((isDoneView ? doneCurrentPage <= 1 : currentPage <= 1) || isFollowUpView) {
                ticketList.innerHTML = '';
            }

            if (ticketData.length === 0) {
                ticketList.innerHTML = `<div class="text-center text-gray-400 mt-8 fade-in"><p>No tickets match your current filters.</p></div>`;
                return;
            }

            const ticketsToRender = (isDoneView ? (doneCurrentPage <= 1) : (currentPage <= 1) || isFollowUpView) ? ticketData : ticketData.slice(-TICKETS_PER_PAGE);

            const visibleTicketIds = ticketsToRender.map(t => t.id);
            const kudosCounts = new Map();
            const kudosIHaveGiven = new Set();

            if (visibleTicketIds.length > 0) {
                const { data: kudosData, error } = await _supabase.from('kudos').select('*').in('ticket_id', visibleTicketIds);
                if (error) console.error("Error fetching kudos:", error);

                if (kudosData) {
                    kudosData.forEach(kudo => {
                        const key = `${kudo.ticket_id}-${kudo.note_index}`;
                        kudosCounts.set(key, (kudosCounts.get(key) || 0) + 1);
                        if (kudo.giver_user_id === currentUser.id) {
                            kudosIHaveGiven.add(key);
                        }
                    });
                }
            }

            const fragment = document.createDocumentFragment();

            ticketsToRender.forEach(ticket => {
                const isDone = ticket.status === 'Done';
                const isMineCreator = currentUser && ticket.created_by === currentUser.id;
                const isAssignedToMe = currentUser && ticket.assigned_to_name === myName;
                const wasReminded = !!ticket.reminder_requested_at;
                const userColor = getUserColor(ticket.username);
                let borderColorClass = 'border-l-4 border-transparent';
                if (ticket.user_id === currentUser.id && !isAssignedToMe) borderColorClass = 'border-l-4 border-indigo-500';
                if (isAssignedToMe) borderColorClass = 'border-l-4 border-purple-500';

                const ticketElement = document.createElement('div');
                ticketElement.id = `ticket-${ticket.id}`;
                ticketElement.className = `ticket-card glassmorphism rounded-lg p-3 shadow-md flex flex-col gap-2 transition-all hover:bg-gray-700/30 fade-in ${isDone ? 'opacity-60' : ''} ${borderColorClass}`;

                const priority = ticket.priority || 'Medium';
                const priorityStyle = PRIORITY_STYLES[priority];
                const tagsHTML = (ticket.tags || []).map(tag => `<span class="bg-gray-600/50 text-gray-300 text-xs font-semibold px-2 py-0.5 rounded-full border border-gray-500">${tag}</span>`).join('');

                let timeToSolveHTML = '';
                if (isDone && ticket.completed_at) {
                    const start = new Date(ticket.created_at);
                    const end = new Date(ticket.completed_at);
                    const diffMs = end - start;
                    const hours = Math.floor(diffMs / 3600000);
                    const minutes = Math.round((diffMs % 3600000) / 60000);
                    timeToSolveHTML = `<div class="flex items-center gap-1 text-xs font-semibold px-2 py-0.5 rounded-full bg-green-500/20 text-green-300"><span>${hours}h ${minutes}m</span></div>`;
                }

                const notesHTML = (ticket.notes || []).map((note, index) => {
                    const isMentioned = note.mentioned_user_ids && note.mentioned_user_ids.length > 0;
                    const mentionClass = isMentioned ? 'mentioned-note' : '';
                    const mentionRegex = /@([\w.-]+)/g;
                    const highlightedText = (note.text || '').replace(mentionRegex, '<span class="text-red-400 font-semibold">@$1</span>');
                    const isMyNote = note.user_id === currentUser.id;
                    const kudosKey = `${ticket.id}-${index}`;
                    const kudosCount = kudosCounts.get(kudosKey) || 0;
                    const haveIGivenKudos = kudosIHaveGiven.has(kudosKey);
                    const WORD_LIMIT = 70;
                    const words = (note.text || '').split(' ');
                    let noteContentHtml;
                    if (words.length > WORD_LIMIT) {
                        noteContentHtml = `
                    <div id="note-text-${ticket.id}-${index}" class="note-text-collapsible collapsed">
                        <p class="note-text text-xs text-white leading-relaxed mt-1">${highlightedText}</p>
                    </div>
                    <button id="toggle-btn-${ticket.id}-${index}" class="toggle-note-btn" onclick="toggleNoteExpansion(${ticket.id}, ${index})">Show More ‚ñæ</button>
                `;
                    } else {
                        noteContentHtml = `<p class="note-text text-xs text-white leading-relaxed mt-1">${highlightedText}</p>`;
                    }
                    let kudosButtonHtml = '';
                    let kudosDisplayHtml = '';
                    if (isMyNote) {
                        if (kudosCount > 0) {
                            kudosDisplayHtml = `<div class="flex items-center gap-1 text-green-400">
                        <span>üëç</span>
                        <span class="text-xs font-bold">${kudosCount}</span>
                    </div>`;
                        }
                    } else {
                        // MODIFICATION: Add 'disabled' class and remove onclick if kudos already given
                        kudosButtonHtml = `<button 
                    id="kudos-btn-${kudosKey}" 
                    ${haveIGivenKudos ? '' : `onclick="giveKudos(${ticket.id}, ${index}, '${note.username}')"`}
                    class="kudos-btn flex items-center gap-1 text-gray-500 hover:text-green-400 transition-all ${haveIGivenKudos ? 'kudos-given disabled' : ''}" 
                    title="${haveIGivenKudos ? 'You gave kudos' : 'Give Kudos'}">
                    <span>üëç</span>
                    ${kudosCount > 0 ? `<span class="text-xs font-bold">${kudosCount}</span>` : ''}
                </button>`;
                    }
                    return `
                <div class="note-container bg-gray-700/30 p-2 rounded-md border border-gray-600/50 slide-in flex justify-between items-start gap-2 ${mentionClass}">
                    <div class="flex-grow min-w-0"> 
                        <div class="flex items-center gap-2">
                            <p class="font-semibold text-gray-400 text-xs">${note.username}</p>
                            ${kudosButtonHtml} ${kudosDisplayHtml}
                        </div>
                        ${noteContentHtml}
                        <p class="text-xs text-gray-500 mt-2">${new Date(note.timestamp).toLocaleString()}</p>
                    </div>
                    <button onclick="deleteNote(${ticket.id}, ${index}, '${note.username}', '${note.user_id || ''}')" class="text-gray-400 hover:text-red-400 transition-colors p-1 opacity-75 hover:opacity-100 flex-shrink-0" title="Delete note">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                    </button>
                </div>`;
                }).join('');
                const warningIconHTML = wasReminded ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-yellow-400 ml-2 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor" title="A reminder was sent for this ticket"><path fill-rule="evenodd" d="M8.257 3.099c.636-1.1 2.29-1.1 2.926 0l6.847 11.982c.636 1.1-.19 2.419-1.463 2.419H2.873c-1.272 0-2.1-1.319-1.463-2.419L8.257 3.099zM10 6a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 6zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>` : '';
                ticketElement.innerHTML = `
        <div class="flex items-start gap-3">
            <div class="flex-shrink-0 w-10 h-10 rounded-full ${userColor.bg} flex items-center justify-center font-bold text-sm border-2 border-gray-600/50 shadow-md">
                ${ticket.username.substring(0, 2).toUpperCase()}
            </div>
            <div class="flex-grow min-w-0">
                <div class="flex justify-between items-center mb-1">
                    <p class="text-xs">
                        <span class="font-bold ${userColor.text}">${ticket.username}</span> 
                        ${ticket.assigned_to_name ? `‚Üí <span class="font-bold text-purple-400">${ticket.assigned_to_name}</span>` : ''}
                    </p>
                    <div class="flex items-center gap-2 flex-shrink-0">
                        <span class="text-xs font-semibold px-2 py-0.5 rounded-full border ${ticket.source === 'Outlook' ? 'bg-blue-500/20 text-blue-300 border-blue-400/30' : 'bg-purple-500/20 text-purple-300 border-purple-400/30'}">${ticket.source}</span>
                        <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${priorityStyle.bg} ${priorityStyle.text}">${priority}</span>
                    </div>
                </div>
                <p class="text-white text-sm font-normal mb-2 leading-snug flex items-center">${ticket.subject} ${warningIconHTML}</p>
                ${tagsHTML ? `<div class="flex gap-2 mb-2 flex-wrap">${tagsHTML}</div>` : ''}
            </div>
            <div onclick="toggleTicketStatus(${ticket.id}, '${ticket.status}')" class="cursor-pointer text-xs font-semibold py-1 px-3 rounded-full h-fit transition-colors border ${isDone ? 'bg-green-500/20 text-green-300 border-green-400/30 hover:bg-green-500/30' : 'bg-yellow-500/20 text-yellow-300 border-yellow-400/30 hover:bg-yellow-500/30'}">
                ${ticket.status}
            </div>
        </div>
        <div class="border-t border-gray-700/30 pt-2 mt-2">
            <div class="space-y-2 mb-2" id="notes-list-${ticket.id}">${notesHTML}</div>
            <div class="note-container relative">
                <div class="flex gap-2 mb-1">
                    <input type="text" id="note-input-${ticket.id}" class="flex-grow bg-gray-700/50 p-2 rounded-lg border border-gray-600 focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-xs" placeholder="Add a note (max ${MAX_NOTE_LENGTH} chars)..." maxlength="${MAX_NOTE_LENGTH}" oninput="updateCharCounter('note-input-${ticket.id}', 'char-counter-${ticket.id}', ${MAX_NOTE_LENGTH})" onkeyup="handleMentionInput(this)" onblur="hideMentionDropdowns()">
                    <button onclick="addNote(${ticket.id})" class="bg-gray-600 hover:bg-gray-700 text-xs py-2 px-3 rounded-lg transition-colors hover-scale">Add</button>
                </div>
                <div class="text-right"><span id="char-counter-${ticket.id}" class="text-xs text-gray-400 char-counter">${MAX_NOTE_LENGTH} characters remaining</span></div>
                <div id="mention-dropdown-${ticket.id}" class="mention-dropdown"></div>
            </div>
            <div class="flex justify-between items-center mt-2">
                 <div class="flex items-center gap-2 text-gray-400 text-xs">
                    <p>Created: ${new Date(ticket.created_at).toLocaleString()}</p>
                    <p class="pl-2 border-l border-gray-600">Updated: ${new Date(ticket.updated_at).toLocaleString()}</p>
                 </div>
                <div class="flex justify-end items-center gap-2">
                    ${isAssignedToMe && ticket.assignment_status === 'pending' ? `<button onclick="acceptAssignment(${ticket.id})" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-1 px-3 rounded-md text-xs hover-scale">Accept</button>` : ''}
                    ${ticket.assignment_status === 'accepted' ? `<span class="text-green-400 text-xs font-semibold">Accepted</span>` : ''}
                    ${ticket.assigned_to_name && isMineCreator && ticket.assignment_status !== 'accepted' && !ticket.reminder_requested_at ? `<button onclick="requestReminder(${ticket.id})" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1 px-3 rounded-md text-xs hover-scale">Remind</button>` : ''}
                    <button onclick="toggleFollowUp(${ticket.id}, ${ticket.needs_followup})" title="Toggle Follow-up" class="p-1 rounded-full hover:bg-gray-700/50">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${ticket.needs_followup ? 'text-yellow-400 fill-current' : 'text-gray-500'}" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                    </button>
                    ${!isAssignedToMe ? `<button onclick="assignToMe(${ticket.id})" class="text-gray-400 hover:text-green-400 p-2 transition-colors hover-scale" title="Assign to Me">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/><path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z"/></svg>
                    </button>` : ''}
                    <button onclick="openEditModal(${ticket.id})" class="text-gray-400 hover:text-indigo-400 p-2 transition-colors hover-scale" title="Edit Ticket">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z"/><path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z"/></svg>
                    </button>
                    ${ticket.user_id === currentUser.id ? `<button onclick="deleteTicket(${ticket.id})" class="text-gray-400 hover:text-red-500 p-2 transition-colors hover-scale" title="Delete Ticket">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                    </button>` : ''}
                </div>
            </div>
        </div>`;
                fragment.appendChild(ticketElement);
            });
            ticketList.appendChild(fragment);
        }


        async function giveKudos(ticketId, noteIndex, receiverUsername) {
            try {
                const receiverUserId = allUsers.get(receiverUsername);
                if (!receiverUserId) throw new Error("Could not find the user to give kudos to.");

                console.log('Attempting to send kudos to user ID:', receiverUserId);

                if (receiverUserId === currentUser.id) {
                    showNotification('Info', "You can't give kudos to yourself.", 'info', false);
                    return;
                }

                const { error } = await _supabase.from('kudos').insert({
                    ticket_id: ticketId,
                    note_index: noteIndex,
                    giver_user_id: currentUser.id,
                    receiver_user_id: receiverUserId
                });

                if (error && error.code !== '23505') throw error;

                awardPoints('KUDOS_RECEIVED', {
                    ticketId,
                    kudosReceiverId: receiverUserId,
                    kudosReceiverUsername: receiverUsername
                });

                // --- NEW: Log this action to the public activity feed ---
                logActivity('KUDOS_GIVEN', {
                    receiver: receiverUsername,
                    ticket_id: ticketId
                });
                // --- End of new code ---

                // Instant UI update
                const kudosBtn = document.getElementById(`kudos-btn-${ticketId}-${noteIndex}`);
                if (kudosBtn) {
                    kudosBtn.classList.add('kudos-given', 'disabled');
                    kudosBtn.title = "You gave kudos";
                    kudosBtn.onclick = null;
                    const countSpan = kudosBtn.querySelector('span:last-child');
                    const currentCount = countSpan ? (parseInt(countSpan.textContent, 10) || 0) : 0;
                    if (countSpan) {
                        countSpan.textContent = currentCount + 1;
                    } else {
                        kudosBtn.innerHTML += `<span class="text-xs font-bold">1</span>`;
                    }
                }

            } catch (err) {
                if (err.code !== '23505') {
                    showNotification('Error', err.message, 'error');
                }
            }
        }

        async function renderStats() {
            const statsContainer = document.getElementById('stats-container');
            if (!statsContainer) return;
            const myName = currentUser.user_metadata.display_name || currentUser.email.split('@')[0];

            // Clear any previous timers to prevent memory leaks
            if (lunchTimerInterval) clearInterval(lunchTimerInterval);

            statsContainer.innerHTML = '<div class="loading-spinner w-8 h-8 mx-auto"></div>';

            const periodSelect = document.getElementById('stats-period');
            let daysToFilter = parseInt(periodSelect.value);
            if (periodSelect.value === 'custom') {
                daysToFilter = parseInt(document.getElementById('custom-days-input').value) || 0;
            }

            const startDate = new Date();
            startDate.setHours(0, 0, 0, 0); // Start of today
            startDate.setDate(startDate.getDate() - (daysToFilter - 1));

            try {
                // --- Step 1: Fetch all tickets for the selected period ---
                let query = _supabase.from('tickets').select('handled_by, username, assigned_to_name').gte('created_at', startDate.toISOString());
                if (currentView === 'tickets') {
                    query = query.eq('status', 'In Progress');
                } else if (currentView === 'done') {
                    query = query.eq('status', 'Done');
                }
                const { data: allTicketsForStats, error } = await query;
                if (error) throw error;

                // --- Step 2: Calculate ticket counts for each user ---
                const userStats = {};
                allTicketsForStats.forEach(ticket => {
                    const handlers = Array.from(new Set(ticket.handled_by || [ticket.assigned_to_name || ticket.username]));
                    handlers.forEach(handlerName => {
                        if (handlerName) {
                            userStats[handlerName] = (userStats[handlerName] || 0) + 1;
                        }
                    });
                });

                statsContainer.innerHTML = '';
                if (allUsers.size === 0) {
                    statsContainer.innerHTML = `<div class="col-span-full text-center text-gray-400"><p>No team data available</p></div>`;
                    return;
                }

                // --- Step 3: Render each user's stat box with the correct status ---
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);

                Array.from(allUsers.keys()).sort().forEach(user => {
                    const count = userStats[user] || 0;
                    const attendanceStatus = attendance.get(user);
                    const userColor = getUserColor(user);

                    let statusHtml = '<div class="w-2 h-2 rounded-full bg-gray-500" title="Offline"></div>';
                    let lunchButtonHtml = '';
                    let timerHtml = '';

                    if (attendanceStatus) {
                        // Shared logic for both online and offline users to display shift time
                        const lastShiftDate = new Date(attendanceStatus.last_shift_start);
                        const lastShiftDateOnly = new Date(lastShiftDate);
                        lastShiftDateOnly.setHours(0, 0, 0, 0);

                        let datePrefix = '';
                        if (lastShiftDateOnly.getTime() === today.getTime()) { datePrefix = 'Today '; }
                        else if (lastShiftDateOnly.getTime() === yesterday.getTime()) { datePrefix = 'Yesterday '; }
                        else { datePrefix = lastShiftDate.toLocaleDateString([], { month: 'short', day: 'numeric' }) + ' '; }

                        const startTime = lastShiftDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        timerHtml = `<span class="text-xs text-gray-400">(${datePrefix}${startTime})</span>`;
                    }

                    if (attendanceStatus && attendanceStatus.status === 'online') {
                        if (attendanceStatus.on_lunch && attendanceStatus.lunch_start_time) {
                            // User is ON LUNCH
                            statusHtml = '<span title="On a break">üçî</span>';
                            if (user === myName) {
                                statusHtml = `<button onclick="toggleLunchStatus()" class="cursor-pointer glowing-pulse-red rounded-full" title="Back from break">üçî</button>`;

                                const lunchStartTime = new Date(attendanceStatus.lunch_start_time);
                                const now = new Date();
                                const diffSeconds = Math.floor((now - lunchStartTime) / 1000);
                                const totalMinutes = Math.floor(diffSeconds / 60);

                                if (totalMinutes < 30) {
                                    lunchTimerInterval = setInterval(() => {
                                        const nowInner = new Date();
                                        const diffSecondsInner = Math.floor((nowInner - lunchStartTime) / 1000);
                                        const secondsRemaining = (30 * 60) - diffSecondsInner;
                                        if (secondsRemaining < 0) return;
                                        const minutes = Math.floor(secondsRemaining / 60);
                                        const seconds = secondsRemaining % 60;
                                        const timerEl = document.getElementById(`lunch-timer-${user.replace(/\./g, '-')}`);
                                        if (timerEl) {
                                            timerEl.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                                        }
                                    }, 1000);
                                    timerHtml = `<div id="lunch-timer-${user.replace(/\./g, '-')}" class="lunch-timer">30:00</div>`;
                                } else {
                                    timerHtml = `<div class="flex items-center justify-center gap-1 text-xs text-red-400 font-semibold"><span class="lunch-warning">‚ö†Ô∏è</span><span>${totalMinutes}m</span></div>`;
                                }
                            } else {
                                const lunchStartTime = new Date(attendanceStatus.lunch_start_time);
                                const now = new Date();
                                const totalMinutes = Math.floor((now - lunchStartTime) / (1000 * 60));
                                timerHtml = `<div class="text-xs text-red-400 font-semibold">(On break: ${totalMinutes}m)</div>`;
                            }
                        } else {
                            // User is ONLINE and AVAILABLE
                            statusHtml = '<div class="w-2 h-2 rounded-full bg-green-500 animate-pulse" title="Online"></div>';
                            if (user === myName) {
                                lunchButtonHtml = `<button onclick="toggleLunchStatus()" class="cursor-pointer" title="Take a break">‚òï</button>`;
                            }
                        }
                    }

                    statsContainer.innerHTML += `
                <div class="glassmorphism p-2 rounded-lg border border-gray-600/30 hover-scale">
                    <div class="flex items-center justify-center gap-2 text-xs ${userColor.text} font-semibold">
                        ${statusHtml}
                        <span class="flex-grow text-center">${user}</span>
                        ${lunchButtonHtml}
                    </div>
                    <div class="text-xl font-bold text-white text-center">${count}</div>
                    <div class="text-center h-4">${timerHtml}</div>
                </div>`;
                });

            } catch (err) {
                console.error('Error fetching stats:', err);
                statsContainer.innerHTML = `<div class="col-span-full text-center text-red-400"><p>Could not load stats.</p></div>`;
            }
        }
        async function renderOnLeaveNotes() {
            const onLeaveContainer = document.getElementById('on-leave-notes');
            onLeaveContainer.innerHTML = '';

            // --- Start of Corrected Code ---
            // Create a date object for today in the user's local timezone.
            const today = new Date();

            // Manually construct a 'YYYY-MM-DD' string from the local date
            // to avoid the timezone conversion bug.
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0'); // +1 because months are 0-indexed
            const day = String(today.getDate()).padStart(2, '0');
            const todayDateString = `${year}-${month}-${day}`;

            // Also create date objects for the start of today and tomorrow for reliable comparisons.
            const startOfToday = new Date(todayDateString + 'T00:00:00');
            const startOfTomorrow = new Date(startOfToday);
            startOfTomorrow.setDate(startOfTomorrow.getDate() + 1);
            // --- End of Corrected Code ---

            try {
                const { data: upcomingOff, error } = await _supabase.from('schedules')
                    .select('username, date')
                    .eq('status', 'Off')
                    .gte('date', todayDateString) // Use the timezone-safe string for the query
                    .order('date', { ascending: true });

                if (error) {
                    console.error("Error fetching absences:", error);
                    throw error;
                }

                if (upcomingOff.length === 0) {
                    onLeaveContainer.innerHTML = '<p class="text-sm text-center text-gray-400">No upcoming absences scheduled.</p>';
                    return;
                }

                const uniqueAbsences = Array.from(new Map(upcomingOff.map(leave => [`${leave.username}-${leave.date}`, leave])).values());

                uniqueAbsences.forEach(leave => {
                    const userColor = getUserColor(leave.username);
                    const leaveDate = new Date(leave.date + 'T00:00:00');
                    let dateString;
                    let isToday = false;

                    // Use the reliable startOfToday object for the comparison
                    if (leaveDate.getTime() === startOfToday.getTime()) {
                        dateString = 'Absent Today';
                        isToday = true;
                    } else if (leaveDate.getTime() === startOfTomorrow.getTime()) {
                        dateString = 'Tomorrow';
                    } else {
                        dateString = leaveDate.toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric' });
                    }

                    onLeaveContainer.innerHTML += `
                <div class="p-3 rounded-lg transition-all ${isToday ? 'bg-amber-500/20 border-l-4 border-amber-500' : 'glassmorphism border border-gray-600/30'}">
                    <p class="font-bold ${userColor.text}">${leave.username}</p>
                    <p class="text-sm text-gray-300">${dateString}</p>
                </div>
            `;
                });
            } catch (err) {
                console.error('Error fetching leave notes:', err);
                onLeaveContainer.innerHTML = '<p class="text-sm text-center text-red-400">Error loading absences.</p>';
            }
        }


        // FIND THIS FUNCTION...
        async function renderAll(isNew = false) {
            showLoading();
            if (isNew) {
                await Promise.all([
                    fetchUsers(),
                    fetchAttendance()
                ]);
                await fetchTickets(true);
                await fetchScheduleItems(); // This is the corrected line
            }
            renderStats();
            populateAllUserDropdowns();
            renderOnLeaveNotes();
            hideLoading();
        }

        // --- CORE LOGIC ---
        function selectSource(source) {
            selectedSource = source;
            document.querySelectorAll('.source-btn').forEach(btn => {
                btn.dataset.selected = (btn.textContent.trim() === source);
            });
        }

        async function createTicket() {
            console.log('Priority selected in dropdown:', document.getElementById('ticket-priority').value);

            if (!currentShiftId) {
                return showNotification('Shift Not Started', 'You must start your shift before creating tickets.', 'error');
            }
            const subject = document.getElementById('ticket-subject').value.trim();
            const assignToName = document.getElementById('assign-to').value;
            const priority = document.getElementById('ticket-priority').value;
            const tagsRaw = document.getElementById('ticket-tags').value.trim();

            if (!subject || !selectedSource) {
                return showNotification('Missing Info', 'Please select a source and enter a subject.', 'error');
            }

            try {
                // --- START: New Duplicate Check Logic ---
                const { count, error: checkError } = await _supabase
                    .from('tickets')
                    .select('*', { count: 'exact', head: true }) // Efficiently gets only the count
                    .eq('subject', subject)
                    .eq('status', 'In Progress');

                if (checkError) throw checkError; // Handle potential query errors

                if (count > 0) {
                    // If count is greater than 0, a duplicate exists.
                    showNotification('Duplicate Ticket', 'A ticket with this subject is already in progress.', 'error');
                    return; // Stop the function here
                }
                // --- END: New Duplicate Check Logic ---

                const tags = tagsRaw ? tagsRaw.split(',').map(t => t.trim()).filter(Boolean) : null;
                const username = currentUser.user_metadata.display_name || currentUser.email.split('@')[0];
                const handled_by = [assignToName || username];

                const ticketData = {
                    user_id: currentUser.id, username, source: selectedSource, subject,
                    status: 'In Progress', assigned_to_name: assignToName || null, priority, tags, handled_by,
                    created_by: currentUser.id,
                    assignment_status: assignToName ? 'pending' : null,
                    assigned_at: assignToName ? new Date().toISOString() : null // MODIFIED: Add timestamp
                };

                const { data, error } = await _supabase.from('tickets').insert(ticketData).select().single();

                if (error) throw error;
                awardPoints('TICKET_OPENED', { ticketId: data.id, priority: priority });

                logActivity('TICKET_CREATED', { ticket_id: data.id, subject: data.subject });
                ['ticket-subject', 'ticket-tags', 'assign-to'].forEach(id => document.getElementById(id).value = '');
                document.querySelectorAll('.source-btn').forEach(btn => btn.dataset.selected = 'false');
                selectedSource = null;

            } catch (error) {
                showNotification('Error Creating Ticket', error.message, 'error');
            }
        }

        function handleMentionInput(inputElement) {
            const currentText = inputElement.value;
            const mentionQueryIndex = currentText.lastIndexOf('@');

            if (mentionQueryIndex !== -1) {
                const query = currentText.substring(mentionQueryIndex + 1).toLowerCase();
                showMentionDropdown(inputElement, query);
            } else {
                hideMentionDropdowns();
            }
        }

        function showMentionDropdown(inputElement, query) {
            const ticketId = inputElement.id.split('-')[2];
            const dropdown = document.getElementById(`mention-dropdown-${ticketId}`);

            const myName = currentUser.user_metadata.display_name || currentUser.email.split('@')[0];
            const users = Array.from(allUsers.keys()).filter(name => name.toLowerCase().includes(query));

            if (users.length > 0) {
                dropdown.innerHTML = users.map(username =>
                    `<div class="mention-item" onmousedown="selectMention('${inputElement.id}', '${username}')">${username}</div>`
                ).join('');

                // Position and show the dropdown
                dropdown.style.display = 'block';
                dropdown.style.top = `${inputElement.offsetTop + inputElement.offsetHeight}px`;
                dropdown.style.left = `${inputElement.offsetLeft}px`;
                dropdown.style.width = `${inputElement.offsetWidth}px`;
            } else {
                dropdown.style.display = 'none';
            }
        }

        function selectMention(inputElementId, username) {
            const inputElement = document.getElementById(inputElementId);
            const currentText = inputElement.value;
            const mentionQueryIndex = currentText.lastIndexOf('@');

            // Replace the text from the @ symbol onwards with the selected username
            inputElement.value = currentText.substring(0, mentionQueryIndex) + `@${username} `;

            hideMentionDropdowns();
            inputElement.focus();
        }

        function hideMentionDropdowns() {
            // A short delay helps register clicks before hiding
            setTimeout(() => {
                document.querySelectorAll('.mention-dropdown').forEach(d => d.style.display = 'none');
            }, 200);
        }

        async function deleteTicket(ticketId) {
            openConfirmModal('Delete Ticket', 'Are you sure you want to delete this ticket? This will also reverse all points awarded for it.', async () => {
                try {
                    // Step 1: Reverse all points associated with this ticket
                    const { error: reversalError } = await _supabase.rpc('reverse_points_for_ticket', {
                        ticket_id_param: ticketId
                    });
                    if (reversalError) throw reversalError;

                    // Step 2: Proceed with deleting the ticket
                    const { error: deleteError } = await _supabase.from('tickets').delete().eq('id', ticketId);
                    if (deleteError) throw deleteError;

                    logActivity('TICKET_DELETED', { ticket_id: ticketId });

                } catch (error) {
                    showNotification('Error Deleting Ticket', error.message, 'error');
                }
            });
        }

        async function toggleTicketStatus(ticketId, currentStatus) {
            try {
                const newStatus = currentStatus === 'Done' ? 'In Progress' : 'Done';
                let updatePayload = { status: newStatus };

                // Find the ticket in the local arrays
                let ticket = tickets.find(t => t.id === ticketId) || doneTickets.find(t => t.id === ticketId);
                if (!ticket) {
                    const { data } = await _supabase.from('tickets').select('*').eq('id', ticketId).single();
                    ticket = data;
                }

                if (!ticket) throw new Error("Ticket not found.");

                if (newStatus === 'Done') {
                    // Only set completed_at the first time it's marked as done
                    if (!ticket.completed_at) {
                        updatePayload.completed_at = new Date().toISOString();
                    }
                    // The awardPoints function will handle the is_reopened check
                    awardPoints('TICKET_CLOSED', { ticketId: ticketId, priority: ticket.priority });
                } else if (newStatus === 'In Progress') {
                    // If moving from Done back to In Progress, mark it as reopened
                    updatePayload.is_reopened = true;
                    // Reverse the points
                    awardPoints('TICKET_REOPENED', { ticketId: ticketId, priority: ticket.priority });
                }

                const { error } = await _supabase.from('tickets').update(updatePayload).eq('id', ticketId);
                if (error) throw error;

                logActivity('STATUS_CHANGED', { ticket_id: ticketId, status: newStatus });
            } catch (err) {
                showNotification('Error', err.message, 'error');
                applyFilters();
            }
        }

        async function addNote(ticketId) {
            const input = document.getElementById(`note-input-${ticketId}`);
            const text = input.value.trim();
            if (!text) return;
            if (text.length > MAX_NOTE_LENGTH) { /* ... error handling ... */ return; }

            try {
                // Find all mentioned usernames in the text
                const mentionRegex = /@([\w.-]+)/g;
                const mentionedUsernames = [...text.matchAll(mentionRegex)].map(match => match[1]);

                // Find the corresponding User IDs from our 'allUsers' Map
                const mentionedUserIds = [];
                mentionedUsernames.forEach(username => {
                    if (allUsers.has(username)) {
                        mentionedUserIds.push(allUsers.get(username));
                    }
                });

                const { data } = await _supabase.from('tickets').select('notes').eq('id', ticketId).single();

                const newNote = {
                    username: currentUser.user_metadata.display_name || currentUser.email.split('@')[0],
                    user_id: currentUser.id, // Also save the author's ID
                    text,
                    timestamp: new Date().toISOString(),
                    mentioned_user_ids: mentionedUserIds // Save the list of User IDs
                };

                const { error } = await _supabase.from('tickets').update({
                    notes: [...(data.notes || []), newNote]
                }).eq('id', ticketId);

                if (error) throw error;

                awardPoints('NOTE_ADDED', { ticketId: ticketId });
                input.value = '';
                // ... (rest of the function remains the same)
            } catch (err) {
                showNotification('Error Adding Note', err.message, 'error');
            }
        }

        async function deleteNote(ticketId, noteIndex, noteAuthor, noteAuthorId) {
            openConfirmModal('Delete Note', 'Are you sure you want to delete this note?', async () => {
                try {
                    // First, deduct the points
                    awardPoints('NOTE_DELETED', {
                        ticketId: ticketId,
                        noteAuthor: noteAuthor,
                        noteAuthorId: noteAuthorId // Pass the original author's ID
                    });

                    // Then, proceed with deleting the note from the ticket
                    const { data } = await _supabase.from('tickets').select('notes').eq('id', ticketId).single();
                    const updatedNotes = [...(data.notes || [])];
                    updatedNotes.splice(noteIndex, 1);

                    const { error } = await _supabase.from('tickets').update({ notes: updatedNotes }).eq('id', ticketId);
                    if (error) throw error;

                    logActivity('NOTE_DELETED', { ticket_id: ticketId });
                } catch (err) {
                    showNotification('Error Deleting Note', err.message, 'error');
                }
            });
        }

        // REPLACE the entire assignToMe function with this new version:
async function assignToMe(ticketId) {
    try {
        const myName = currentUser.user_metadata.display_name || currentUser.email.split('@')[0];
        
        // First, fetch all the necessary ticket info
        const { data: ticket, error: fetchError } = await _supabase
            .from('tickets')
            .select('handled_by, username, assigned_to_name, status, priority, created_by')
            .eq('id', ticketId)
            .single();

        if (fetchError) throw fetchError;

        const currentHandlers = ticket.handled_by || [ticket.username];
        const newHandlers = [...new Set([...currentHandlers, myName])];

        const updatePayload = {
            assigned_to_name: myName,
            status: 'In Progress',
            handled_by: newHandlers,
            assignment_status: 'accepted',
            assigned_at: new Date().toISOString() // This is the new timestamp
        };

        // If taking from "Done" tab, prepare to mark it as reopened
        if (ticket.status === 'Done') {
            updatePayload.is_reopened = true;
        }
        
        // --- THIS IS THE FIX ---
        
        // 1. FIRST, update the ticket in the database with the new 'assigned_at' timestamp.
        const { error: updateError } = await _supabase.from('tickets').update(updatePayload).eq('id', ticketId);
        if (updateError) throw updateError;
        
        // 2. NOW, with the database updated, call awardPoints. 
        //    The Edge Function will now see the correct 'assigned_at' and apply the 8-hour rule properly.
        if (ticket.assigned_to_name !== myName) {
            awardPoints('ASSIGN_TO_SELF', { ticketId: ticketId });
        }
        
        // 3. Handle the point deduction for reopening separately, after the main update.
        if (ticket.status === 'Done') {
             awardPoints('TICKET_REOPENED', { ticketId: ticketId, priority: ticket.priority });
             showNotification('Ticket Reopened', 'This ticket was taken from the Done tab and has been marked as reopened.', 'info');
        }
        // --- END OF FIX ---

        logActivity('TICKET_ASSIGNED', { ticket_id: ticketId, assigned_to: myName });

    } catch (err) {
        showNotification('Error assigning ticket', err.message, 'error');
    }
}

        // REPLACE the entire toggleFollowUp function with this new version:
        async function toggleFollowUp(ticketId, currentState) {
            const { error } = await _supabase.from('tickets').update({ needs_followup: !currentState }).eq('id', ticketId);
            if (error) {
                showNotification('Error', 'Failed to update follow-up status.', 'error');
            } else if (currentState === false) { // Toggled ON
                awardPoints('TICKET_FOLLOWUP_ADDED', { ticketId: ticketId });
                // ... (log activity)
            }
        }

        // REPLACE the entire acceptAssignment function with this new version:
        async function acceptAssignment(ticketId) {
            try {
                const { data: ticket, error: fetchError } = await _supabase.from('tickets').select('assigned_at').eq('id', ticketId).single();
                if (fetchError) throw fetchError;

                if (ticket.assigned_at) {
                    const assignedTime = new Date(ticket.assigned_at);
                    const now = new Date();
                    const diffSeconds = (now - assignedTime) / 1000;

                    // Bonus for accepting within 2 minutes (120 seconds)
                    if (diffSeconds < 120) {
                        awardPoints('ACCEPT_ASSIGNMENT_QUICKLY', { ticketId: ticketId, timeToAccept: diffSeconds });
                    }
                    // NEW RULE: Penalty for responding after 15 minutes (900 seconds)
                    else if (diffSeconds > 900) {
                        awardPoints('SLOW_ACCEPTANCE', { ticketId: ticketId, timeToAccept: diffSeconds });
                    }
                }

                const { error } = await _supabase.from('tickets').update({ assignment_status: 'accepted' }).eq('id', ticketId);
                if (error) throw error;
                showNotification('Accepted', `You've accepted the ticket.`, 'success', false);
            } catch (err) {
                showNotification('Error', 'Could not accept assignment.', 'error');
            }
        }

        async function requestReminder(ticketId) {
            const { error } = await _supabase.from('tickets').update({ reminder_requested_at: new Date().toISOString() }).eq('id', ticketId);
            if (error) showNotification('Error', 'Could not set reminder.', 'error');
            else showNotification('Reminder Set', 'The assignee will be reminded.', 'info', false);
        }

        function checkReminders(currentTicketList) {
            if (!currentUser || !currentTicketList) return;
            const tenMinutesAgo = new Date(Date.now() - 10 * 60 * 1000);
            const myName = currentUser.user_metadata.display_name || currentUser.email.split('@')[0];

            currentTicketList.forEach(ticket => {
                if (ticket.assigned_to_name === myName &&
                    ticket.assignment_status === 'pending' &&
                    ticket.reminder_requested_at &&
                    new Date(ticket.reminder_requested_at) <= tenMinutesAgo) {

                    showNotification('Reminder!', `Please check ticket: ${ticket.subject}`, 'info', true);
                }
            });
        }


        function playSoundAlert() {
            const audio = new Audio('/assets/alarm.mp3');
            audio.play().catch(error => {
                console.error("Audio playback failed. This can happen if the user hasn't interacted with the page yet.", error);
            });
        }

        // --- MODALS & ADMIN ---
        function openEditModal(id) {
            const ticket = [...tickets, ...doneTickets, ...followUpTickets].find(t => t.id === id);
            if (!ticket) return;

            document.getElementById('edit-ticket-id').value = id;
            document.getElementById('edit-subject').value = ticket.subject;
            document.getElementById('edit-status').value = ticket.status;
            document.getElementById('edit-priority').value = ticket.priority || 'Medium';
            document.getElementById('edit-tags').value = (ticket.tags || []).join(', ');

            // Show the complexity dropdown ONLY if the user is an admin
            const complexityContainer = document.getElementById('complexity-container');
            if (currentUserRole === 'admin') {
                document.getElementById('edit-complexity').value = ticket.complexity || 1;
                complexityContainer.classList.remove('hidden');
            } else {
                complexityContainer.classList.add('hidden');
            }

            const modal = document.getElementById('edit-modal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
        }
        function closeEditModal() {
            const modal = document.getElementById('edit-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
        async function updateTicket() {
            const id = document.getElementById('edit-ticket-id').value;
            const newSubject = document.getElementById('edit-subject').value;
            const newStatus = document.getElementById('edit-status').value;
            const newPriority = document.getElementById('edit-priority').value;
            const newComplexity = document.getElementById('edit-complexity').value; // Get the complexity value
            const tagsRaw = document.getElementById('edit-tags').value.trim();
            const tags = tagsRaw ? tagsRaw.split(',').map(t => t.trim()).filter(Boolean) : null;

            try {
                // First, get all necessary old ticket data before we change it
                const { data: oldTicket, error: fetchError } = await _supabase
                    .from('tickets')
                    .select('priority, user_id, username, complexity')
                    .eq('id', id)
                    .single();

                if (fetchError) throw fetchError;

                // Check if priority or complexity has changed
                if (oldTicket.priority !== newPriority || oldTicket.complexity !== parseInt(newComplexity)) {
                    // Pass the original user as the target for the point adjustment
                    awardPoints('SCORE_ADJUSTED', {
                        ticketId: id,
                        oldPriority: oldTicket.priority,
                        newPriority: newPriority,
                        oldComplexity: oldTicket.complexity || 1,
                        newComplexity: parseInt(newComplexity)
                    }, { userId: oldTicket.user_id, username: oldTicket.username });
                }

                // Now, prepare the payload and proceed with the update
                let updatePayload = {
                    subject: newSubject,
                    status: newStatus,
                    priority: newPriority,
                    tags,
                    complexity: newComplexity
                };

                // Add completed_at timestamp if the ticket is being marked as 'Done'
                if (newStatus === 'Done') {
                    const { data: ticket } = await _supabase.from('tickets').select('completed_at').eq('id', id).single();
                    if (ticket && !ticket.completed_at) {
                        updatePayload.completed_at = new Date().toISOString();
                    }
                }

                // Perform the final update
                const { error } = await _supabase.from('tickets').update(updatePayload).eq('id', id);
                if (error) throw error;

                closeEditModal();
                logActivity('TICKET_EDITED', { ticket_id: id, subject: newSubject });

            } catch (err) {
                showNotification('Error Updating Ticket', err.message, 'error');
            }
        }
        function openConfirmModal(title, message, callback) {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            confirmCallback = callback;
            const modal = document.getElementById('confirm-modal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
            document.getElementById('confirm-btn').onclick = () => {
                if (confirmCallback) confirmCallback();
                closeConfirmModal();
            };
        }
        function closeConfirmModal() {
            const modal = document.getElementById('confirm-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
            confirmCallback = null;
        }
        async function deleteTicketsByDate() {
            const startDate = document.getElementById('delete-start-date').value;
            const endDate = document.getElementById('delete-end-date').value;

            if (!startDate || !endDate) {
                return showNotification('Error', 'Please select both a start and end date.', 'error');
            }

            if (new Date(startDate) > new Date(endDate)) {
                return showNotification('Error', 'Start date cannot be after the end date.', 'error');
            }

            const endOfDay = new Date(endDate);
            endOfDay.setHours(23, 59, 59, 999);

            openConfirmModal(
                'Confirm Deletion',
                `Are you sure you want to permanently delete all tickets from ${startDate} to ${endDate}?`,
                async () => {
                    showLoading();
                    const { error } = await _supabase.from('tickets')
                        .delete()
                        .gte('created_at', new Date(startDate).toISOString())
                        .lte('created_at', endOfDay.toISOString());

                    hideLoading();
                    if (error) {
                        showNotification('Error', 'Failed to delete tickets in the selected range.', 'error');
                        console.error('Deletion error:', error);
                    } else {
                        showNotification('Success', 'Tickets in the selected range have been deleted.', 'success');
                        applyFilters();
                    }
                }
            );
        }


        // Add these functions to your main <script> tag

        function openNewPasswordModal() {
            const modal = document.getElementById('new-password-modal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
        }

        function closeNewPasswordModal() {
            const modal = document.getElementById('new-password-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        // This function is called when the user clicks "Save New Password"
        async function setNewPassword() {
            const newPassword = document.getElementById('new-password-input').value;

            if (newPassword.length < 6) {
                showNotification('Password Too Short', 'Your password must be at least 6 characters long.', 'error');
                return;
            }

            // This Supabase function updates the user's password.
            // It works because the user is already signed in via the secure link.
            const { data, error } = await _supabase.auth.updateUser({
                password: newPassword
            });

            if (error) {
                showNotification('Error', error.message, 'error');
            } else {
                showNotification('Success!', 'Your password has been updated successfully.', 'success');
                closeNewPasswordModal();
            }
        }

        // --- BROADCAST MESSAGE FUNCTIONS ---
        // NOTE: This feature requires a new table named `broadcast_messages`
        // Columns: id (pk), created_at, message_text (text), created_by (uuid), is_active (boolean)
        // RLS Policy: Enable read for all authenticated users. Enable insert/update for admins.
        async function postBroadcastMessage() {
            const input = document.getElementById('broadcast-input');
            const message = input.value.trim();
            if (!message) return;

            showLoading();
            try {
                // Deactivate old messages
                const { error: deactivateError } = await _supabase.from('broadcast_messages')
                    .update({ is_active: false })
                    .eq('is_active', true);
                if (deactivateError) throw deactivateError;

                // Insert new message
                const { error: insertError } = await _supabase.from('broadcast_messages').insert({
                    message: message,
                    user_id: currentUser.id,
                    is_active: true
                });
                if (insertError) throw insertError;

                input.value = '';
                showNotification('Success', 'Broadcast message posted!', 'success');
            } catch (err) {
                showNotification('Error', err.message, 'error');
            } finally {
                hideLoading();
            }
        }

        async function fetchBroadcastMessage() {
            console.log("1. Starting to fetch broadcast message...");
            try {
                const { data, error } = await _supabase.from('broadcast_messages')
                    .select('*')
                    .eq('is_active', true)
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .single();

                console.log("2. Supabase query finished.", { data, error });

                if (error && error.code !== 'PGRST116') {
                    console.error("   -> A database error occurred:", error);
                    throw error;
                }

                const container = document.getElementById('broadcast-message-container');
                if (data) {
                    console.log("3. Active message found in database:", data);

                    const dismissedId = sessionStorage.getItem('dismissedBroadcastId');
                    console.log("4. Checking session storage. Dismissed ID is:", dismissedId);

                    if (dismissedId === data.id.toString()) {
                        console.log("   -> Decision: Hide banner because message ID was previously dismissed.");
                        container.classList.add('hidden');
                        return;
                    }

                    console.log("5. Attempting to show the banner...");
                    const textElement = document.getElementById('broadcast-message-text');
                    if (textElement && container) {
                        textElement.textContent = data.message;
                        container.dataset.id = data.id;
                        container.classList.remove('hidden');
                        console.log("   -> SUCCESS: Banner should now be visible.");
                    } else {
                        console.error("   -> FAILURE: Could not find '#broadcast-message-container' or '#broadcast-message-text' in the HTML.");
                    }

                } else {
                    console.log("3. No active message found in the database. Banner will remain hidden.");
                    if (container) {
                        container.classList.add('hidden');
                    }
                }
            } catch (err) {
                console.error("CRITICAL ERROR in fetchBroadcastMessage:", err);
            }
        }

        function dismissBroadcast() {
            const container = document.getElementById('broadcast-message-container');
            const messageId = container.dataset.id;
            if (messageId) {
                sessionStorage.setItem('dismissedBroadcastId', messageId);
            }
            container.classList.add('hidden');
        }


        // --- ATTENDANCE & SHIFT ---
        function updateShiftButton(isInShift, isShiftDoneForDay) {
            const shiftBtn = document.getElementById("shift-btn");
            const footer = document.getElementById('tickets-footer');
            shiftBtn.disabled = false;
            shiftBtn.classList.remove("bg-gray-600", "cursor-not-allowed", "bg-cyan-600", "hover:bg-cyan-700", "bg-orange-600", "hover:bg-orange-700");
            if (isShiftDoneForDay) {
                shiftBtn.textContent = "Shift Ended";
                shiftBtn.disabled = true;
                shiftBtn.classList.add("bg-gray-600", "cursor-not-allowed");
                footer.classList.add('disabled');
            } else if (isInShift) {
                shiftBtn.textContent = "End Shift";
                shiftBtn.classList.add("bg-orange-600", "hover:bg-orange-700");
                footer.classList.remove('disabled');
            } else {
                shiftBtn.textContent = "Start Shift";
                shiftBtn.classList.add("bg-cyan-600", "hover:bg-cyan-700");
                footer.classList.add('disabled');
            }
        }

        async function toggleLunchStatus() {
            if (!currentShiftId) {
                return showNotification('Error', 'You must be in a shift to take a break.', 'error');
            }
            try {
                const myName = currentUser.user_metadata.display_name || currentUser.email.split('@')[0];
                const myAttendance = attendance.get(myName) || {};
                const isOnLunch = !!myAttendance.lunch_start_time;

                const { error } = await _supabase.from('attendance')
                    .update({ on_lunch: !isOnLunch, lunch_start_time: isOnLunch ? null : new Date().toISOString() })
                    .eq('id', currentShiftId);

                if (error) throw error;
                // The real-time subscription will automatically call renderStats() to update the UI.
            } catch (err) {
                showNotification('Error', 'Could not update lunch status.', 'error');
            }
        }

        async function fetchAttendance() {
            try {
                const myName = currentUser.user_metadata.display_name || currentUser.email.split('@')[0];
                const { data: users, error: usersError } = await _supabase.rpc('get_team_members');
                if (usersError) throw usersError;

                const uniqueUsernames = [...new Set(users.map(u => u.username).filter(Boolean))];

                const attendancePromises = uniqueUsernames.map(username =>
                    _supabase.from('attendance')
                        .select('id, shift_start, shift_end, on_lunch, lunch_start_time')
                        .eq('username', username)
                        .order('created_at', { ascending: false })
                        .limit(1)
                );
                const results = await Promise.all(attendancePromises);

                attendance.clear();
                uniqueUsernames.forEach((username, index) => {
                    // --- THIS BLOCK IS THE FIX ---
                    const result = results[index];
                    if (result.error) {
                        console.error(`Failed to fetch attendance for ${username}:`, result.error);
                        return; // Skip this user if there was an error
                    }
                    const latestShift = result.data ? result.data[0] : null;
                    // --- END OF FIX ---

                    if (latestShift) {
                        const isOnline = !latestShift.shift_end;
                        attendance.set(username, {
                            id: latestShift.id,
                            status: isOnline ? 'online' : 'offline',
                            last_shift_start: latestShift.shift_start,
                            on_lunch: latestShift.on_lunch,
                            lunch_start_time: latestShift.lunch_start_time
                        });
                        if (username === myName && isOnline) {
                            currentShiftId = latestShift.id;
                        }
                    }
                });

                if (currentUser) {
                    const myAttendance = attendance.get(myName);
                    const isInShift = myAttendance && myAttendance.status === 'online';
                    if (!isInShift) { currentShiftId = null; }
                    updateShiftButton(isInShift, false);
                }

            } catch (err) {
                console.error('Exception fetching attendance:', err);
            }
        }


        async function toggleShift() { currentShiftId ? openConfirmModal('End Shift', 'Are you sure?', endShift) : await startShift(); }
        async function startShift() {
            try {
                updateShiftButton(true, false);
                const username = currentUser.user_metadata.display_name || currentUser.email.split('@')[0];
                const device = getDeviceType();
                const newShift = {
                    user_id: currentUser.id,
                    username: username,
                    last_shift_start: new Date().toISOString(),
                    device_type: device
                };
                const { data, error } = await _supabase.from('attendance').insert(newShift).select().single();
                if (error) {
                    updateShiftButton(false, false);
                    throw error;
                }
                awardPoints('SHIFT_STARTED');
                currentShiftId = data.id;
                logActivity('SHIFT_START', {});
            } catch (err) {
                showNotification('Error Starting Shift', err.message, 'error');
            }
        }
        async function endShift() {
            if (lunchTimerInterval) clearInterval(lunchTimerInterval); // ADD THIS

            try {
                if (!currentShiftId) {
                    throw new Error("No active shift found to end.");
                }
                const { error } = await _supabase.from('attendance')
                    .update({ shift_end: new Date().toISOString() })
                    .eq('id', currentShiftId);

                if (error) throw error;

                logActivity('SHIFT_END', {});
                updateShiftButton(false, false);
                currentShiftId = null;
            } catch (err) {
                showNotification('Error Ending Shift', err.message, 'error');
            }
        }

        async function autoEndStaleShifts() {
            try {
                const { data: activeShifts, error: shiftsError } = await _supabase
                    .from('attendance').select('id, username, shift_start').is('shift_end', null);

                if (shiftsError) throw shiftsError;
                if (activeShifts.length === 0) return;

                const { data: allOverrides, error: overridesError } = await _supabase.from('schedules').select('*');
                if (overridesError) throw overridesError;
                const { data: allDefaults, error: defaultsError } = await _supabase.from('default_schedules').select('*');
                if (defaultsError) throw defaultsError;

                const updatesToPerform = [];
                for (const shift of activeShifts) {
                    const shiftStartDate = new Date(shift.shift_start);
                    const shiftDateStr = shiftStartDate.toISOString().split('T')[0];
                    const dayOfWeek = shiftStartDate.getDay() === 0 ? 7 : shiftStartDate.getDay();

                    let userSchedule = allOverrides.find(s => s.username === shift.username && s.date === shiftDateStr) ||
                        allDefaults.find(d => d.username === shift.username && d.day_of_week === dayOfWeek);

                    if (userSchedule && userSchedule.status === 'Working' && userSchedule.shift_end_time) {
                        const [endHour, endMinute] = userSchedule.shift_end_time.split(':').map(Number);
                        const scheduledEndTime = new Date(shift.shift_start);
                        scheduledEndTime.setHours(endHour, endMinute, 0, 0);

                        if (shiftStartDate > scheduledEndTime) scheduledEndTime.setDate(scheduledEndTime.getDate() + 1);

                        const cutOffTime = new Date(scheduledEndTime.getTime() + 3 * 60 * 60 * 1000);

                        if (new Date() > cutOffTime) {
                            updatesToPerform.push({
                                id: shift.id,
                                shift_end: scheduledEndTime.toISOString()
                            });
                        }
                    }
                }

                if (updatesToPerform.length > 0) {
                    // This loop replaces the single faulty .upsert() call
                    for (const update of updatesToPerform) {
                        const { error: updateError } = await _supabase
                            .from('attendance')
                            .update({ shift_end: update.shift_end })
                            .eq('id', update.id);

                        if (updateError) {
                            console.error(`Failed to auto-end shift ID ${update.id}:`, updateError);
                        }
                    }
                    showNotification('System Notice', `${updatesToPerform.length} overdue shift(s) have been automatically ended.`, 'info', false);
                }
            } catch (err) {
                console.error("Error in autoEndStaleShifts:", err);
            }
        }


        // --- SCHEDULE FUNCTIONS ---
        async function checkScheduleUpdate() {
            try {
                const { data: lastUpdate, error: updateError } = await _supabase.from('activity_log')
                    .select('created_at, details')
                    .eq('activity_type', 'SCHEDULE_UPDATED')
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .single();

                if (updateError && updateError.code !== 'PGRST116') throw updateError;
                if (!lastUpdate) return;

                const { data: { user } } = await _supabase.auth.getUser();
                const lastViewTime = user.user_metadata.last_schedule_view;
                const scheduleBtn = document.getElementById('schedule-btn');
                const scheduleDot = document.getElementById('schedule-dot');

                window.lastScheduleUpdate = lastUpdate;

                if (!lastViewTime || new Date(lastUpdate.created_at) > new Date(lastViewTime)) {
                    scheduleBtn.classList.add('glowing-pulse');
                    scheduleDot.classList.remove('hidden');
                } else {
                    scheduleBtn.classList.remove('glowing-pulse');
                    scheduleDot.classList.add('hidden');
                }
            } catch (err) {
                console.error('Error checking schedule update:', err);
            }
        }
        async function openScheduleModal() {
            const modal = document.getElementById('schedule-modal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);

            document.getElementById('schedule-date-picker').value = new Date().toISOString().split('T')[0];
            await fetchSchedule();
            highlightOverriddenDates();

            const { data: roleData } = await _supabase.from('user_roles').select('role').eq('user_id', currentUser.id).single();
            if (roleData && roleData.role === 'admin') {
                document.getElementById('admin-schedule-buttons').classList.remove('hidden');
            }

            const scheduleBtn = document.getElementById('schedule-btn');
            scheduleBtn.classList.remove('glowing-pulse');
            document.getElementById('schedule-dot').classList.add('hidden');
            await _supabase.auth.updateUser({ data: { last_schedule_view: new Date().toISOString() } });
        }
        function closeScheduleModal() {
            const modal = document.getElementById('schedule-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
            toggleScheduleEdit(false);
        }
        async function fetchSchedule() {
            const date = document.getElementById('schedule-date-picker').value;
            const dayOfWeek = new Date(date + 'T00:00:00').getDay();
            const displayDiv = document.getElementById('schedule-display');
            displayDiv.innerHTML = '<div class="loading-spinner w-8 h-8 mx-auto"></div>';

            try {
                const { data: overrides, error: overrideError } = await _supabase.from('schedules').select('*').eq('date', date);
                const { data: defaults, error: defaultError } = await _supabase.from('default_schedules').select('*');
                if (overrideError || defaultError) {
                    showNotification('Error', (overrideError || defaultError).message, 'error');
                    return;
                }

                const isRecentlyUpdated = window.lastScheduleUpdate &&
                    window.lastScheduleUpdate.details &&
                    window.lastScheduleUpdate.details.date === date &&
                    new Date(window.lastScheduleUpdate.created_at) > new Date(Date.now() - 24 * 60 * 60 * 1000);

                let scheduleData = [];
                Array.from(allUsers.keys()).forEach(username => {
                    const defaultSched = defaults.find(d => d.username === username && d.day_of_week === (dayOfWeek === 0 ? 7 : dayOfWeek)) || { status: 'Not Set' };
                    const overrideSched = overrides.find(o => o.username === username);

                    const finalSchedule = overrideSched || defaultSched;

                    const isOverride = !!overrideSched && (
                        overrideSched.status !== defaultSched.status ||
                        overrideSched.shift_start_time !== defaultSched.shift_start_time ||
                        overrideSched.shift_end_time !== defaultSched.shift_end_time
                    );

                    scheduleData.push({ username, schedule: finalSchedule, isOverride });
                });

                scheduleData.sort((a, b) => {
                    if (a.schedule.status === 'Working' && b.schedule.status !== 'Working') return -1;
                    if (a.schedule.status !== 'Working' && b.schedule.status === 'Working') return 1;
                    if (a.schedule.shift_start_time < b.schedule.shift_start_time) return -1;
                    if (a.schedule.shift_start_time > b.schedule.shift_start_time) return 1;
                    return 0;
                });

                displayDiv.innerHTML = '';
                scheduleData.forEach(({ username, schedule, isOverride }) => {
                    const userColor = getUserColor(username);
                    let scheduleInfo = '<span class="text-gray-400">Not Set</span>';
                    let overrideClass = isOverride ? 'bg-indigo-700/50' : 'glassmorphism';

                    const redDot = isRecentlyUpdated && isOverride ?
                        '<span class="inline-block w-2 h-2 bg-red-500 rounded-full ml-2 animate-pulse"></span>' : '';

                    if (schedule.status === 'Off') {
                        scheduleInfo = `<span class="font-bold text-red-400">Off Day</span>`;
                    } else if (schedule.status === 'Working') {
                        scheduleInfo = `<span class="font-bold text-green-400">${formatTime(schedule.shift_start_time)} - ${formatTime(schedule.shift_end_time)}</span>`;
                    }

                    displayDiv.innerHTML += `
                        <div class="${overrideClass} p-3 rounded-lg flex items-center justify-between border border-gray-600/30">
                            <span class="font-semibold ${userColor.text} flex items-center">${username}${redDot}</span>
                            ${scheduleInfo}
                        </div>
                    `;
                });
            } catch (err) {
                console.error('Error fetching schedule:', err);
                showNotification('Error', 'Failed to fetch schedule', 'error');
            }
        }
        async function toggleScheduleEdit(isEditing) {
            document.getElementById('schedule-display').classList.toggle('hidden', isEditing);
            document.getElementById('admin-schedule-buttons').classList.toggle('hidden', isEditing);
            document.getElementById('schedule-edit-form').classList.toggle('hidden', !isEditing);
            document.getElementById('schedule-edit-actions').classList.toggle('hidden', !isEditing);
            document.getElementById('schedule-edit-actions').classList.toggle('flex', isEditing);
            document.getElementById('overridden-dates-info').classList.toggle('hidden', isEditing);


            if (isEditing) {
                const date = document.getElementById('schedule-date-picker').value;
                const dayOfWeek = new Date(date + 'T00:00:00').getDay();
                const formDiv = document.getElementById('schedule-edit-form');
                formDiv.innerHTML = '<div class="loading-spinner w-8 h-8 mx-auto"></div>';

                try {
                    const { data: overrides, error: overrideError } = await _supabase.from('schedules').select('*').eq('date', date);
                    const { data: defaults, error: defaultError } = await _supabase.from('default_schedules').select('*').eq('day_of_week', dayOfWeek === 0 ? 7 : dayOfWeek);
                    if (overrideError || defaultError) {
                        showNotification('Error', (overrideError || defaultError).message, 'error');
                        return;
                    }

                    const userSchedules = new Map();
                    Array.from(allUsers.keys()).forEach(name => {
                        const override = overrides.find(o => o.username === name);
                        const defaultSched = defaults.find(d => d.username === name);
                        userSchedules.set(name, override || defaultSched || { status: 'Off', shift_start_time: '09:00', shift_end_time: '17:00' });
                    });

                    formDiv.innerHTML = '';
                    Array.from(userSchedules.entries()).sort().forEach(([username, schedule]) => {
                        const userColor = getUserColor(username);
                        formDiv.innerHTML += `
                            <div class="glassmorphism p-3 rounded-lg grid grid-cols-4 gap-2 items-center border border-gray-600/30">
                                <span class="font-semibold ${userColor.text} col-span-4 sm:col-span-1">${username}</span>
                                <select data-username="${username}" class="schedule-status bg-gray-600/50 p-2 rounded-lg col-span-2 sm:col-span-1 border border-gray-500">
                                    <option ${schedule.status === 'Working' ? 'selected' : ''}>Working</option>
                                    <option ${schedule.status === 'Off' ? 'selected' : ''}>Off</option>
                                </select>
                                <input type="time" data-username="${username}" value="${schedule.shift_start_time || '09:00'}" class="schedule-start bg-gray-600/50 p-2 rounded-lg border border-gray-500">
                                <input type="time" data-username="${username}" value="${schedule.shift_end_time || '17:00'}" class="schedule-end bg-gray-600/50 p-2 rounded-lg border border-gray-500">
                            </div>
                        `;
                    });
                } catch (err) {
                    console.error('Error setting up schedule edit:', err);
                    showNotification('Error', 'Failed to setup schedule editing', 'error');
                }
            }
        }
        async function saveSchedule() {
            const date = document.getElementById('schedule-date-picker').value;
            const statusInputs = document.querySelectorAll('.schedule-status');
            const startInputs = document.querySelectorAll('.schedule-start');
            const endInputs = document.querySelectorAll('.schedule-end');

            const upsertData = Array.from(statusInputs).map((statusEl, index) => {
                const username = statusEl.dataset.username;
                const userId = allUsers.get(username);
                if (!userId) return null;
                return {
                    user_id: userId,
                    username: username,
                    date: date,
                    status: statusEl.value,
                    shift_start_time: startInputs[index].value || null,
                    shift_end_time: endInputs[index].value || null,
                };
            }).filter(Boolean);

            if (upsertData.length === 0) { return; }

            try {
                const { error } = await _supabase.from('schedules').upsert(upsertData, { onConflict: 'user_id, date' });
                if (error) throw error;

                await logActivity('SCHEDULE_UPDATED', { date: date });
                toggleScheduleEdit(false);
                await fetchSchedule();
                await highlightOverriddenDates();
            } catch (err) {
                showNotification('Error Saving Schedule', err.message, 'error');
            }
        }

        // --- DEFAULT SCHEDULE MODAL ---
        let currentDayTab = 1;
        async function openDefaultScheduleModal() {
            const modal = document.getElementById('default-schedule-modal');
            modal.classList.remove('hidden');
            setTimeout(() => modal.classList.remove('opacity-0'), 10);
            switchDayTab(document.querySelector('.tab-button[data-day="1"]'), 1);
        }
        function closeDefaultScheduleModal() {
            const modal = document.getElementById('default-schedule-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
        async function switchDayTab(tab, day) {
            currentDayTab = day;
            document.querySelectorAll('#default-schedule-modal .tab-button').forEach(t => {
                t.classList.remove('bg-indigo-600', 'text-white');
                t.classList.add('text-gray-400');
            });
            tab.classList.add('bg-indigo-600', 'text-white');
            tab.classList.remove('text-gray-400');
            await fetchDefaultSchedule(day);
        }
        async function fetchDefaultSchedule(day) {
            const formDiv = document.getElementById('default-schedule-form');
            formDiv.innerHTML = '<div class="loading-spinner w-8 h-8 mx-auto"></div>';

            try {
                const { data, error } = await _supabase.from('default_schedules').select('*').eq('day_of_week', day);
                if (error) throw error;

                const userSchedules = new Map();
                Array.from(allUsers.keys()).forEach(name => userSchedules.set(name, { status: 'Off', shift_start_time: '09:00', shift_end_time: '17:00' }));
                data.forEach(item => userSchedules.set(item.username, item));

                formDiv.innerHTML = '';
                Array.from(userSchedules.entries()).sort().forEach(([username, schedule]) => {
                    const userColor = getUserColor(username);
                    formDiv.innerHTML += `
                        <div class="glassmorphism p-3 rounded-lg grid grid-cols-4 gap-2 items-center border border-gray-600/30">
                            <span class="font-semibold ${userColor.text} col-span-4 sm:col-span-1">${username}</span>
                            <select data-username="${username}" class="default-schedule-status bg-gray-600/50 p-2 rounded-lg col-span-2 sm:col-span-1 border border-gray-500">
                                <option ${schedule.status === 'Working' ? 'selected' : ''}>Working</option>
                                <option ${schedule.status === 'Off' ? 'selected' : ''}>Off</option>
                            </select>
                            <input type="time" data-username="${username}" value="${schedule.shift_start_time || '09:00'}" class="default-schedule-start bg-gray-600/50 p-2 rounded-lg border border-gray-500">
                            <input type="time" data-username="${username}" value="${schedule.shift_end_time || '17:00'}" class="default-schedule-end bg-gray-600/50 p-2 rounded-lg border border-gray-500">
                        </div>
                    `;
                });
            } catch (err) {
                showNotification('Error', err.message, 'error');
            }
        }
        async function saveDefaultSchedule() {
            const statusInputs = document.querySelectorAll('.default-schedule-status');
            const startInputs = document.querySelectorAll('.default-schedule-start');
            const endInputs = document.querySelectorAll('.default-schedule-end');

            const upsertData = Array.from(statusInputs).map((statusEl, index) => {
                const username = statusEl.dataset.username;
                const userId = allUsers.get(username);
                if (!userId) return null;
                return {
                    user_id: userId,
                    username: username,
                    day_of_week: currentDayTab,
                    status: statusEl.value,
                    shift_start_time: startInputs[index].value || null,
                    shift_end_time: endInputs[index].value || null,
                };
            }).filter(Boolean);

            if (upsertData.length === 0) return;

            try {
                const { error } = await _supabase.from('default_schedules').upsert(upsertData, { onConflict: 'user_id, day_of_week' });
                if (error) throw error;
                const dayNames = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
                await logActivity('DEFAULT_SCHEDULE_SAVED', { day: dayNames[currentDayTab - 1] });
            } catch (err) {
                showNotification('Error Saving Defaults', err.message, 'error');
            }
        }

        async function highlightOverriddenDates() {
            const infoDiv = document.getElementById('overridden-dates-info');
            const picker = document.getElementById('schedule-date-picker');
            const selectedDate = new Date(picker.value + 'T00:00:00');
            const year = selectedDate.getFullYear();
            const month = selectedDate.getMonth();

            const firstDay = new Date(year, month, 1).toISOString().split('T')[0];
            const lastDay = new Date(year, month + 1, 0).toISOString().split('T')[0];

            // ADDED: Get today's date to compare against
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            infoDiv.classList.add('hidden');

            try {
                const [overridesResult, defaultsResult] = await Promise.all([
                    _supabase.from('schedules').select('*').gte('date', firstDay).lte('date', lastDay),
                    _supabase.from('default_schedules').select('*')
                ]);

                const { data: overrides, error: overridesError } = overridesResult;
                const { data: defaults, error: defaultsError } = defaultsResult;

                if (overridesError || defaultsError) throw (overridesError || defaultsError);

                const overriddenDates = new Set();

                overrides.forEach(override => {
                    // MODIFIED: Added a date check here
                    const overrideDate = new Date(override.date + 'T00:00:00');
                    if (overrideDate >= today) {
                        const dayOfWeek = overrideDate.getDay();
                        const supabaseDayOfWeek = dayOfWeek === 0 ? 7 : dayOfWeek;
                        const defaultSched = defaults.find(d => d.username === override.username && d.day_of_week === supabaseDayOfWeek);

                        let isDifferent = true;
                        if (defaultSched) {
                            if (override.status === defaultSched.status &&
                                override.shift_start_time === defaultSched.shift_start_time &&
                                override.shift_end_time === defaultSched.shift_end_time) {
                                isDifferent = false;
                            }
                        }

                        if (isDifferent) {
                            overriddenDates.add(override.date.split('-')[2]);
                        }
                    }
                });

                if (overriddenDates.size > 0) {
                    const monthName = selectedDate.toLocaleString('default', { month: 'long' });
                    const sortedDays = Array.from(overriddenDates).map(d => parseInt(d)).sort((a, b) => a - b);
                    infoDiv.textContent = `üóìÔ∏è Note: The schedule for ${monthName} has overrides on the following days: ${sortedDays.join(', ')}.`;
                    infoDiv.classList.remove('hidden');
                }

            } catch (err) {
                console.error('Error highlighting overridden dates:', err);
            }
        }

        // --- ACTIVITY LOG FUNCTIONS ---
        async function logActivity(activity_type, details) {
            try {
                const { error } = await _supabase.from('activity_log').insert({
                    user_id: currentUser.id,
                    username: currentUser.user_metadata.display_name || currentUser.email.split('@')[0],
                    activity_type,
                    details
                });
                if (error) throw error;
            } catch (err) { console.error('Error logging activity:', err); }
        }
        async function fetchActivities() {
            try {
                const { data: { user }, error: userError } = await _supabase.auth.getUser();
                if (userError) throw userError;
                const lastActivityView = user.user_metadata.last_activity_view || '1970-01-01T00:00:00.000Z';

                const { data, error } = await _supabase.from('activity_log').select('*').order('created_at', { ascending: false }).limit(20);
                if (error) throw error;

                const list = document.getElementById('activity-list');
                const myId = currentUser.id;

                list.innerHTML = data.map(log => {
                    const isUnread = new Date(log.created_at) > new Date(lastActivityView) && log.user_id !== myId;
                    const unreadClass = isUnread ? 'unread-activity' : '';
                    const unreadIndicator = isUnread ? '<div class="absolute left-1 top-3 bottom-3 w-1 bg-indigo-400 rounded-full"></div>' : '';

                    return `<div class="relative p-3 border-b border-gray-700/50 text-sm ${unreadClass}">
                                ${unreadIndicator}
                                <p class="pl-3">${formatActivity(log)}</p>
                                <p class="pl-3 text-xs text-gray-400 mt-1">${new Date(log.created_at).toLocaleString()}</p>
                            </div>`;
                }).join('');

            } catch (err) {
                console.error('Error fetching activities:', err);
            }
        }
        function formatActivity(log) {
            const { username, activity_type, details } = log;
            const userHtml = `<strong>${username}</strong>`;
            switch (activity_type) {
                case 'KUDOS_GIVEN':
                    return `${userHtml} gave kudos to <strong>${details.receiver}</strong> on a ticket.`;
                case 'TICKET_CREATED':
                    return `${userHtml} created ticket: "${details.subject || ''}"`;
                case 'STATUS_CHANGED':
                    return `${userHtml} set a ticket's status to <strong>${details.status}</strong>`;
                case 'TICKET_ASSIGNED':
                    return `${userHtml} took assignment of a ticket.`;
                case 'TICKET_EDITED':
                    return `${userHtml} edited ticket: "${details.subject || ''}"`;
                case 'NOTE_ADDED':
                    return `${userHtml} added a note to a ticket.`;
                case 'NOTE_DELETED':
                    return `${userHtml} deleted a note from a ticket.`;
                case 'TICKET_DELETED':
                    return `${userHtml} deleted a ticket.`;
                case 'SHIFT_START':
                    return `${userHtml} started their shift.`;
                case 'SHIFT_END':
                    return `${userHtml} ended their shift.`;
                case 'SCHEDULE_UPDATED':
                    return `${userHtml} updated the schedule for <strong>${details.date}</strong>.`;
                case 'DEFAULT_SCHEDULE_SAVED':
                    return `${userHtml} saved the default schedule for <strong>${details.day}</strong>.`;
                case 'FOLLOWUP_ADDED':
                    return `${userHtml} flagged a ticket for follow-up.`
                default:
                    return `${userHtml} performed an action.`;
            }
        }
        async function toggleActivityLog(forceClose = false) {
            const log = document.getElementById('activity-log');
            if (forceClose) {
                log.classList.add('hidden');
                return;
            }
            log.classList.toggle('hidden');

            // This block runs when the log is OPENED
            if (!log.classList.contains('hidden')) {
                document.getElementById('activity-dot').classList.add('hidden');

                // 1. Fetch and display the list immediately, showing the items as "unread".
                fetchActivities();

                // 2. After 3 seconds, mark them as read in the database and then re-render the list.
                setTimeout(async () => {
                    try {
                        // This updates the timestamp, effectively "reading" the items.
                        await _supabase.auth.updateUser({ data: { last_activity_view: new Date().toISOString() } });
                        // This re-fetches the list, which will now remove the "unread" visual style.
                        await fetchActivities();
                    } catch (err) {
                        console.error('Error marking activities as read:', err);
                    }
                }, 3000); // 3000 milliseconds = 3 seconds
            }
        }

        async function checkForUnreadActivities() {
            try {
                const { data: { user } } = await _supabase.auth.getUser();
                if (!user) return;
                const lastActivityView = user.user_metadata.last_activity_view || '1970-01-01T00:00:00.000Z';

                const { count, error } = await _supabase.from('activity_log')
                    .select('*', { count: 'exact', head: true })
                    .gt('created_at', lastActivityView)
                    .neq('user_id', currentUser.id);

                if (error) {
                    console.error("Error checking unread activities:", error);
                    return;
                };

                const activityDot = document.getElementById('activity-dot');
                if (count > 0) {
                    activityDot.classList.remove('hidden');
                } else {
                    activityDot.classList.add('hidden');
                }
            } catch (err) {
                console.error('Error checking for unread activities:', err);
            }
        }

        async function checkForUnreadFollowUps() {
            try {
                const { data: { user } } = await _supabase.auth.getUser();
                if (!user) return;
                const lastFollowUpView = user.user_metadata.last_followup_view || '1970-01-01T00:00:00.000Z';

                const { count, error } = await _supabase.from('tickets')
                    .select('*', { count: 'exact', head: true })
                    .eq('needs_followup', true)
                    .gt('updated_at', lastFollowUpView);

                if (error) {
                    console.error("Error checking unread follow-ups:", error);
                    return;
                }
                const followUpDot = document.getElementById('follow-up-dot');
                if (count > 0) {
                    followUpDot.classList.remove('hidden');
                } else {
                    followUpDot.classList.add('hidden');
                }

            } catch (err) {
                console.error("Exception checking follow-ups", err);
            }
        }

        // --- VIEW SWITCHING & SIDEBAR ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('sidebar-backdrop');
            sidebar.classList.toggle('-translate-x-full');
            backdrop.classList.toggle('hidden');
        }
        function toggleRightSidebar() {
            const sidebar = document.getElementById('on-leave-sidebar');
            const backdrop = document.getElementById('right-sidebar-backdrop');
            sidebar.classList.toggle('translate-x-full');
            backdrop.classList.toggle('hidden');
        }
        async function switchView(viewName, clickedButton) {
            currentView = viewName;
            const indicator = document.getElementById('tab-indicator');
            const tabs = document.querySelectorAll('.tab-btn');

            if (clickedButton) {
                indicator.style.left = `${clickedButton.offsetLeft}px`;
                indicator.style.width = `${clickedButton.offsetWidth}px`;

                const colors = { dashboard: 'bg-indigo-600', tickets: 'bg-amber-600', done: 'bg-green-600', 'follow-up': 'bg-slate-600' };
                indicator.className = `absolute top-0 bottom-0 h-full rounded-md transition-all duration-300 ease-in-out ${colors[viewName]}`;
            }

            tabs.forEach(tab => tab.classList.remove('text-white'));
            if (clickedButton) clickedButton.classList.add('text-white');

            const views = { dashboard: 'dashboard-view', tickets: 'tickets-view', done: 'done-view', 'follow-up': 'follow-up-view' };
            Object.values(views).forEach(v => document.getElementById(v).classList.add('hidden'));

            document.getElementById(views[viewName]).classList.remove('hidden');

            const filterBar = document.getElementById('tickets-filter-bar');
            filterBar.style.display = 'none';

            if (['tickets', 'done', 'follow-up'].includes(viewName)) {
                if (viewName === 'follow-up') {
                    document.getElementById('follow-up-dot').classList.add('hidden');
                    _supabase.auth.updateUser({ data: { last_followup_view: new Date().toISOString() } });
                }
                filterBar.style.display = 'block';
                await applyFilters();
            } else if (viewName === 'dashboard') {
                await renderDashboard();
                await renderStats();
            }
        }

        // --- SMART SHIFT REMINDER ---
        async function checkShiftReminders() {
            if (!currentUser || !allUsers.size) return;

            const myName = currentUser.user_metadata.display_name || currentUser.email.split('@')[0];
            const reminderContainer = document.getElementById('shift-reminder-container');

            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const dayOfWeek = today.getDay() === 0 ? 7 : today.getDay();

            const { data, error: overrideError } = await _supabase.from('schedules').select('*').eq('username', myName).eq('date', todayStr);

            if (overrideError) {
                console.error("Error fetching schedule override:", overrideError);
            }

            // If an override exists in the data array, use it. Otherwise, it's null.
            const override = data && data.length > 0 ? data[0] : null;
            let schedule = override;
            if (!schedule) {
                const { data: defaultSched, error: defaultError } = await _supabase.from('default_schedules').select('*').eq('username', myName).eq('day_of_week', dayOfWeek).single();
                if (defaultError && defaultError.code !== 'PGRST116') console.error(defaultError);
                schedule = defaultSched;
            }

            if (!schedule || schedule.status !== 'Working' || !schedule.shift_start_time || !schedule.shift_end_time) {
                reminderContainer.textContent = '';
                return;
            }

            const [startHour, startMinute] = schedule.shift_start_time.split(':').map(Number);
            const shiftStartTime = new Date();
            shiftStartTime.setHours(startHour, startMinute, 0, 0);

            const [endHour, endMinute] = schedule.shift_end_time.split(':').map(Number);
            const shiftEndTime = new Date();
            shiftEndTime.setHours(endHour, endMinute, 0, 0);

            const shiftEndReminderTime = new Date(shiftEndTime.getTime() - 10 * 60 * 1000);

            const myAttendance = attendance.get(myName);
            const isInShift = myAttendance && myAttendance.status === 'online';

            if (!isInShift && today >= shiftStartTime && today < shiftEndTime) {
                reminderContainer.textContent = "Time to start your shift!";
            } else if (isInShift && today >= shiftEndReminderTime && today < shiftEndTime) {
                const minutesLeft = Math.round((shiftEndTime - today) / 60000);
                reminderContainer.textContent = `Shift ends in ${minutesLeft} min!`;
            } else {
                reminderContainer.textContent = '';
            }
        }


        // --- DASHBOARD ---
        async function renderDashboard() {
            showLoading();
            const selectedUser = document.getElementById('dashboard-user-filter').value;
            const periodSelect = document.getElementById('stats-period');
            let daysToFilter = parseInt(periodSelect.value);
            if (periodSelect.value === 'custom') {
                daysToFilter = parseInt(document.getElementById('custom-days-input').value) || 0;
            }

            const startDate = new Date();
            startDate.setHours(0, 0, 0, 0);
            startDate.setDate(startDate.getDate() - (daysToFilter - 1));

            try {
                const { data, error } = await _supabase.from('tickets').select('*').gte('created_at', startDate.toISOString());
                if (error) throw error;

                const userTickets = selectedUser === 'all' ? data : data.filter(t => (t.handled_by || []).includes(selectedUser));
                const doneTickets = userTickets.filter(t => t.status === 'Done' && t.completed_at);

                const resolutionContainer = document.getElementById('avg-resolution-time-container');
                resolutionContainer.innerHTML = `<h3 class="text-lg font-semibold text-gray-300 mb-4">Avg. Resolution Time</h3>`;
                const priorityStats = {};

                doneTickets.forEach(t => {
                    const priority = t.priority || 'Medium';
                    if (!priorityStats[priority]) {
                        priorityStats[priority] = { totalMs: 0, count: 0 };
                    }
                    priorityStats[priority].totalMs += new Date(t.completed_at) - new Date(t.created_at);
                    priorityStats[priority].count++;
                });

                const priorityOrder = ['Urgent', 'High', 'Medium', 'Low'];
                let hasResolutionData = false;
                priorityOrder.forEach(priority => {
                    if (priorityStats[priority] && priorityStats[priority].count > 0) {
                        hasResolutionData = true;
                        const stats = priorityStats[priority];
                        const avgMs = stats.totalMs / stats.count;
                        const hours = Math.floor(avgMs / 3600000);
                        const minutes = Math.round((avgMs % 3600000) / 60000);
                        const priorityStyle = PRIORITY_STYLES[priority];

                        resolutionContainer.innerHTML += `
                            <div class="flex items-center justify-between p-2 rounded-lg ${priorityStyle.bg} mb-2">
                                <span class="font-semibold ${priorityStyle.text}">${priority}</span>
                                <span class="font-bold text-lg ${priorityStyle.text}">${hours}h ${minutes}m</span>
                            </div>
                        `;
                    }
                });

                if (!hasResolutionData) {
                    resolutionContainer.innerHTML += `<p class="text-sm text-gray-400 mt-4">No completed tickets with this filter.</p>`;
                }

                const sourceCounts = userTickets.reduce((acc, t) => { acc[t.source] = (acc[t.source] || 0) + 1; return acc; }, {});

                const priorityCounts = userTickets.reduce((acc, t) => { const p = t.priority || 'Medium'; acc[p] = (acc[p] || 0) + 1; return acc; }, {});
                const priorityLabels = Object.keys(priorityCounts);
                const priorityColorMap = { 'Low': '#22c55e', 'Medium': '#f59e0b', 'High': '#ef4444', 'Urgent': '#b91c1c' };
                const priorityBackgroundColors = priorityLabels.map(label => priorityColorMap[label] || '#6b7280');

                const ticketsPerDay = {};
                userTickets.forEach(t => { const day = new Date(t.created_at).toISOString().split('T')[0]; ticketsPerDay[day] = (ticketsPerDay[day] || 0) + 1; });
                const sortedDays = Object.keys(ticketsPerDay).sort();
                const titleSuffix = selectedUser === 'all' ? `(All Members)` : `(${selectedUser})`;
                renderChart('tickets-by-source-container', 'sourceChart', 'pie', { labels: Object.keys(sourceCounts), datasets: [{ data: Object.values(sourceCounts), backgroundColor: ['#3b82f6', '#8b5cf6'] }] }, `Tickets by Source ${titleSuffix}`);
                renderChart('tickets-by-priority-container', 'priorityChart', 'doughnut', { labels: priorityLabels, datasets: [{ data: priorityLabels.map(l => priorityCounts[l]), backgroundColor: priorityBackgroundColors }] }, `Tickets by Priority ${titleSuffix}`);
                renderChart('tickets-per-day-container', 'dailyChart', 'bar', { labels: sortedDays, datasets: [{ label: 'Tickets Created', data: sortedDays.map(day => ticketsPerDay[day]), backgroundColor: '#4f46e5' }] }, `Daily Volume ${titleSuffix}`);
            } catch (err) {
                console.error("Dashboard fetch error:", err);
                showNotification('Dashboard Error', 'Failed to load dashboard data', 'error');
            } finally {
                hideLoading();
            }
        }
        function renderChart(containerId, chartKey, type, data, title) {
            const container = document.getElementById(containerId);
            container.innerHTML = `<canvas id="${chartKey}"></canvas>`;
            if (charts[chartKey]) { charts[chartKey].destroy(); }
            const ctx = document.getElementById(chartKey).getContext('2d');
            charts[chartKey] = new Chart(ctx, {
                type,
                data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { color: '#d1d5db' }
                        },
                        title: {
                            display: true,
                            text: title,
                            color: '#d1d5db',
                            font: { size: 16 }
                        }
                    },
                    scales: type === 'bar' ? {
                        y: {
                            ticks: { color: '#9ca3af' },
                            grid: { color: '#374151' }
                        },
                        x: {
                            ticks: { color: '#9ca3af' },
                            grid: { color: '#374151' }
                        }
                    } : {}
                }
            });
        }



        // --- INITIALIZATION & SUBSCRIPTIONS ---
        function populateAllUserDropdowns() {
            const assignSelect = document.getElementById("assign-to");
            const filterSelect = document.getElementById("filter-user");
            const dashboardFilterSelect = document.getElementById("dashboard-user-filter");

            assignSelect.innerHTML = '<option value="">Assign to (optional)</option>';
            filterSelect.innerHTML = '<option value="">All Users</option>';
            dashboardFilterSelect.innerHTML = '<option value="all">All Team Members</option>';

            const sortedUsers = Array.from(allUsers.keys()).sort();
            const myName = currentUser.user_metadata.display_name || currentUser.email.split('@')[0];

            sortedUsers.forEach(name => {
                if (name !== myName) {
                    const assignOption = document.createElement("option");
                    assignOption.value = name;
                    assignOption.textContent = name;
                    assignSelect.appendChild(assignOption);
                }

                const filterOption = document.createElement("option");
                filterOption.value = name;
                filterOption.textContent = name;
                filterSelect.appendChild(filterOption);

                const dashboardOption = document.createElement("option");
                dashboardOption.value = name;
                dashboardOption.textContent = name;
                dashboardFilterSelect.appendChild(dashboardOption);
            });
        }

        async function initializeApp(session) {
            if (currentUser && currentUser.id === session.user.id) return;
            try {
                currentUser = session.user;
                await checkAndDisableUIForVisitor();

                _supabase.channel(`notifications-for-${currentUser.id}`)
                    .on('postgres_changes',
                        {
                            event: 'INSERT',
                            schema: 'public',
                            table: 'notifications',
                            filter: `user_id=eq.${currentUser.id}`
                        },
                        payload => {
                            showNotification('You were mentioned!', payload.new.message, 'info');
                        }
                    ).subscribe();

                document.getElementById('current-user').textContent = currentUser.user_metadata.display_name || currentUser.email.split('@')[0];

                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('app-container').classList.remove('hidden');

                if (Notification.permission === "default") {
                    Notification.requestPermission().then(permission => {
                        if (permission === "granted") {
                            new Notification("Notifications Enabled!", {
                                body: "You will now receive real-time updates.",
                                icon: "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéüÔ∏è</text></svg>"
                            });
                        }
                    });
                }

                const { data: roleData } = await _supabase.from('user_roles').select('role').eq('user_id', currentUser.id).single();
                if (roleData && (roleData.role === 'admin' || roleData.role === 'visitor_admin')) {
                    document.getElementById('open-admin-panel-btn').classList.remove('hidden');
                }

                const initialTab = document.getElementById('tab-tickets');

                await renderAll(true);
                renderLeaderboard();
                switchView('tickets', initialTab);
                fetchBroadcastMessage();

                checkScheduleUpdate();
                fetchActivities();
                checkForUnreadActivities();
                checkForUnreadFollowUps();
                setInterval(renderLeaderboard, 5 * 60 * 1000);

                if (shiftReminderInterval) clearInterval(shiftReminderInterval);
                shiftReminderInterval = setInterval(checkShiftReminders, 60000);
                checkShiftReminders();

                if (autoEndShiftInterval) clearInterval(autoEndShiftInterval);
                autoEndShiftInterval = setInterval(autoEndStaleShifts, 15 * 60 * 1000); // Check every 15 minutes
                autoEndStaleShifts();

            } catch (err) {
                console.error('Exception during initialization:', err);
                showNotification('Initialization Error', 'Failed to initialize app', 'error');
            }
        }

        function resetApp() {
            currentUser = null;
            tickets = [];
            doneTickets = [];
            followUpTickets = [];
            allUsers.clear();
            attendance.clear();
            currentShiftId = null;
            if (shiftReminderInterval) clearInterval(shiftReminderInterval);
            if (autoEndShiftInterval) clearInterval(autoEndShiftInterval);

            document.getElementById('login-overlay').style.display = 'flex';
            document.getElementById('app-container').classList.add('hidden');

            document.getElementById('ticket-list').innerHTML = '';
            document.getElementById('done-ticket-list').innerHTML = '';
            document.getElementById('follow-up-ticket-list').innerHTML = '';
            document.getElementById('stats-container').innerHTML = '';
        }

        document.addEventListener('keydown', e => {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'Enter' && document.activeElement.id === 'ticket-subject') {
                    e.preventDefault();
                    createTicket();
                }
                if (e.key === 'f') {
                    e.preventDefault();
                    document.getElementById('search-input').focus();
                }
            }
            if (e.key === 'Escape') {
                closeEditModal();
                closeConfirmModal();
                closeScheduleModal();
                closeDefaultScheduleModal();
                toggleActivityLog(true);
            }
        });

        document.addEventListener('DOMContentLoaded', () => {

            document.getElementById('signin-btn').addEventListener('click', signIn);
            document.getElementById('signup-btn').addEventListener('click', signUp);
            document.getElementById('search-input').addEventListener('input', debouncedApplyFilters);
            document.getElementById('my-performance-btn').addEventListener('click', openPerformanceModal);
            document.getElementById('close-performance-modal-btn').addEventListener('click', closePerformanceModal);
            document.getElementById('performance-modal').addEventListener('click', (e) => { if (e.target.id === 'performance-modal') closePerformanceModal(); });
            document.getElementById('open-history-btn').addEventListener('click', openHistoryModal);



            document.getElementById('email-input').addEventListener('keypress', e => {
                if (e.key === 'Enter') document.getElementById('password-input').focus();
            });
            document.getElementById('password-input').addEventListener('keypress', e => {
                if (e.key === 'Enter') signIn();
            });

            document.addEventListener('click', function (event) {
                const activityLog = document.getElementById('activity-log');
                const activityBtn = document.getElementById('activity-btn');

                if (!activityLog.classList.contains('hidden') && !activityLog.contains(event.target) && !activityBtn.contains(event.target)) {
                    activityLog.classList.add('hidden');
                }
            });

            const ticketSubjectInput = document.getElementById('ticket-subject');
            if (ticketSubjectInput) {
                ticketSubjectInput.addEventListener('keypress', e => {
                    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                        e.preventDefault();
                        createTicket();
                    }
                });
            }

            (async () => {
                try {
                    const { data: { session } } = await _supabase.auth.getSession();
                    if (session) await initializeApp(session);
                    else {
                        document.getElementById('loading-overlay').classList.add('hidden');
                    }

                    _supabase.auth.onAuthStateChange(async (event, session) => {
                        session ? await initializeApp(session) : resetApp();
                    });

                    _supabase.channel('public-all-changes')
                        .on('postgres_changes', { event: '*', schema: 'public' }, async (payload) => {
                            if (!currentUser) return;
                            console.log('Realtime change detected:', payload.table);

                            if (payload.table === 'pings' && payload.eventType === 'INSERT') {
                                const pingData = payload.new;
                                // Check if this ping is for the current user
                                if (pingData.target_user_id === currentUser.id) {
                                    playSoundAlert(); // Play a sound to get their attention
                                    alert(`Message from Admin:\n\n${pingData.message}`);
                                }
                            }

                            if (payload.table === 'tickets' || payload.table === 'kudos') {
                                // --- Sound alert logic (runs ONLY on UPDATE) ---
                                if (payload.eventType === 'UPDATE') {
                                    const updatedTicket = payload.new;
                                    const myName = currentUser.user_metadata.display_name || currentUser.email.split('@')[0];

                                    const reminderTime = new Date(updatedTicket.reminder_requested_at);
                                    const now = new Date();

                                    const isForMe = updatedTicket.assigned_to_name === myName;
                                    const isRecent = updatedTicket.reminder_requested_at && (now - reminderTime < 10000);
                                    const isAssignedToOther = updatedTicket.assigned_to_name && (updatedTicket.username !== updatedTicket.assigned_to_name);

                                    if (isForMe && isRecent && isAssignedToOther) {
                                        playSoundAlert();
                                        showNotification('Reminder!', `A reminder was requested for ticket: "${updatedTicket.subject}"`, 'info', true);
                                    }
                                }

                                // --- General UI refresh (runs on INSERT, UPDATE, and DELETE) ---
                                await applyFilters();
                                await checkForUnreadFollowUps();
                            }
                            if (payload.table === 'schedules') {
                                checkScheduleUpdate();
                                renderOnLeaveNotes();
                            }
                            if (payload.table === 'attendance') {
                                await fetchAttendance();
                                await renderStats();
                            }
                            if (payload.table === 'broadcast_messages') {
                                await fetchBroadcastMessage();
                            }
                            if (payload.table === 'deployment_notes') {
                                await fetchScheduleItems();
                            }
                            if (payload.table === 'activity_log' && payload.eventType === 'INSERT') {
                                const activity = payload.new;
                                const isOriginator = activity.user_id === currentUser.id;
                                const isLogOpen = !document.getElementById('activity-log').classList.contains('hidden');

                                showNotification(isOriginator ? 'Action Logged' : 'New Team Activity', formatActivity(activity), isOriginator ? 'success' : 'info', !isOriginator);

                                if (!isOriginator && !isLogOpen) {
                                    document.getElementById('activity-dot').classList.remove('hidden');
                                }

                                if (isLogOpen) {
                                    await fetchActivities();
                                }
                            }

                        }).subscribe();

                } catch (err) {
                    console.error('Error during app initialization:', err);
                    showNotification('Startup Error', 'Failed to initialize application properly', 'error');
                }
            })();
        });
    </script>
</body>

</html>


