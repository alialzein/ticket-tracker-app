<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migrate Templates to Database</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .container {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        h1 {
            color: #6366f1;
            margin-bottom: 20px;
        }
        button {
            background: #6366f1;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
        }
        button:hover {
            background: #4f46e5;
        }
        button:disabled {
            background: #4b5563;
            cursor: not-allowed;
        }
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 6px;
            display: none;
        }
        .status.success {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.3);
            color: #86efac;
            display: block;
        }
        .status.error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
            display: block;
        }
        .info {
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid rgba(99, 102, 241, 0.3);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        ul {
            margin: 10px 0;
            padding-left: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Migrate Default Templates to Database</h1>

        <div class="info">
            <strong>This will create 2 external templates in your database:</strong>
            <ul>
                <li><strong>Urgent Maintenance</strong> - For urgent maintenance notifications</li>
                <li><strong>Scheduled Maintenance</strong> - For scheduled maintenance with details table</li>
            </ul>
            <p>Both templates will:</p>
            <ul>
                <li>Be marked as <strong>external</strong> (auto-populate BCC with active client emails)</li>
                <li>Have default CC recipients pre-configured</li>
                <li>Appear in your template dropdown in the Clients page</li>
            </ul>
            <p><strong>Note:</strong> You can run this multiple times - it will only create templates if they don't already exist.</p>
        </div>

        <button id="migrateBtn" onclick="migrateTemplates()">Migrate Templates to Database</button>

        <div id="status" class="status"></div>
    </div>

    <script type="module">
        // Import Supabase config from your existing file
        const SUPABASE_URL = 'https://gpdtbbqszfrjdjshdsou.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdwZHRiYnFzemZyamRqc2hkc291Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQzNTM0NzIsImV4cCI6MjA0OTkyOTQ3Mn0.IrVFiIfwrDbhzV-JsBkGy6UrFhx1OvtqIHRJKXMTLMU';

        window.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        window.migrateTemplates = async function() {
            const btn = document.getElementById('migrateBtn');
            const status = document.getElementById('status');

            btn.disabled = true;
            btn.textContent = 'Migrating...';
            status.className = 'status';
            status.style.display = 'none';

            try {
                const templates = [
                    {
                        name: 'Urgent Maintenance',
                        subject: 'Urgent Maintenance Notification',
                        body: `<p>Hello Team,</p>
<p>Kindly note that we have an urgent maintenance next Tuesday 21/10/2025 at 6 AM GMT time, which will require a restart of the B-Pal Web service.</p>
<p>The downtime will be 5-10 minutes; please don't make any updates on B-Pal during the activity.</p>
<p>Traffic will not be affected by this maintenance.</p>
<p>Regards,<br>B-Pal Support Team</p>`,
                        template_type: 'external',
                        to_recipients: '',
                        cc: '"Ali Sabbagh" <ali.sabbagh@montymobile.com>, "B-Pal Support" <support@b-pal.net>, "Mohammad Aboud" <mohammad.aboud@montymobile.com>',
                        bcc: ''  // Auto-populated for external templates
                    },
                    {
                        name: 'Scheduled Maintenance',
                        subject: 'Scheduled Maintenance Notification',
                        body: `<p>Hello Team,</p>
<p>We would like to inform you that on Sep 16, 2025, a maintenance will take place Tuesday September 16th as per the below.<br>
You might face service interruptions at the web level between 5:45 am and 6:15 am GMT time.<br>
Traffic will not be affected.</p>
<p><strong>BPAL Maintenance</strong></p>
<table style="border-collapse: collapse; width: 100%; border: 1px solid #ddd;">
<tbody>
<tr>
<td style="border: 1px solid #ddd; padding: 8px;"><strong>Date</strong></td>
<td style="border: 1px solid #ddd; padding: 8px;">Date/Time (GMT Time):<br>Tuesday Sep 16th, 2025, between 5:45 and 6:15 am</td>
</tr>
<tr>
<td style="border: 1px solid #ddd; padding: 8px;"><strong>IMPACT</strong></td>
<td style="border: 1px solid #ddd; padding: 8px;">User may face interruption at the level of BPAL web</td>
</tr>
</tbody>
</table>
<p>Regards,<br>B-Pal Support Team</p>`,
                        template_type: 'external',
                        to_recipients: '',
                        cc: '"Ali Sabbagh" <ali.sabbagh@montymobile.com>, "B-Pal Support" <support@b-pal.net>, "Mohammad Aboud" <mohammad.aboud@montymobile.com>',
                        bcc: ''  // Auto-populated for external templates
                    }
                ];

                let created = 0;
                let skipped = 0;

                for (const template of templates) {
                    // Check if template already exists
                    const { data: existing } = await window.supabase
                        .from('email_templates')
                        .select('id')
                        .eq('name', template.name)
                        .single();

                    if (existing) {
                        console.log(`Template "${template.name}" already exists, skipping...`);
                        skipped++;
                        continue;
                    }

                    // Insert template
                    const { error } = await window.supabase
                        .from('email_templates')
                        .insert(template);

                    if (error) throw error;

                    console.log(`Created template: ${template.name}`);
                    created++;
                }

                status.className = 'status success';
                status.innerHTML = `
                    <strong>✅ Migration Complete!</strong><br>
                    <ul>
                        <li>Created: ${created} template(s)</li>
                        <li>Skipped (already exists): ${skipped} template(s)</li>
                    </ul>
                    <p>You can now close this page and use the templates in your Clients page.</p>
                `;
                btn.textContent = 'Migration Complete ✓';

            } catch (error) {
                console.error('Migration error:', error);
                status.className = 'status error';
                status.innerHTML = `
                    <strong>❌ Migration Failed</strong><br>
                    ${error.message}
                `;
                btn.disabled = false;
                btn.textContent = 'Retry Migration';
            }
        };
    </script>
</body>
</html>
